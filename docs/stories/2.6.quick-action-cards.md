# Story 2.6: Quick Action Cards for Navigation

## Status

Draft

## Story

**As a** user,
**I want** to see quick-action cards summarizing my calories, injections, and Nirvana status,
**so that** I can quickly navigate to those sections and see my progress at a glance.

## Acceptance Criteria

1. "Quick Actions" section displayed on Daily Tracker below MITs and weight tracking
2. Three cards displayed in responsive grid (1 column mobile, 3 columns desktop):
   - **Calories Summary Card**
   - **Injections Summary Card**
   - **Nirvana Status Card**
3. **Calories Summary Card** shows:
   - Icon (FireIcon)
   - "Calorie Balance" title
   - Current balance value (e.g., "+450 cal" or "-320 cal")
   - Color-coded: Green (positive), Red (negative)
   - Click navigates to /calories
4. **Injections Summary Card** shows:
   - Icon (BeakerIcon)
   - "Injections This Week" title
   - Count of injections in past 7 days
   - Click navigates to /injections
5. **Nirvana Status Card** shows:
   - Icon (UserIcon)
   - "Nirvana Life" title
   - Session completion indicator (e.g., "2/7 sessions this week")
   - Click navigates to /nirvana
6. Cards styled with hover effects (scale slightly, border color change)
7. Cards use MM design system card-mm class
8. Loading states displayed while data fetches (skeleton loaders)

## Tasks / Subtasks

- [ ] Task 1: Create calorie balance calculation utility (AC: 3)
  - [ ] Add function to `lib/utils/calculations.ts` (or `lib/services/calorie-balance.ts`)
  - [ ] Implement `calculateCalorieBalance(bmr: number, foodEntries: FoodEntry[], exerciseEntries: ExerciseEntry[]): number`
  - [ ] Formula: `BMR - totalFoodCalories + totalExerciseCalories`
  - [ ] Write unit tests for calculation
  - [ ] Note: This is preparatory - food_entries and exercise_entries tables don't exist yet (built in Epic 3)

- [ ] Task 2: Create QuickActionCards client component (AC: 1, 2, 6, 7, 8)
  - [ ] Create file `components/daily/QuickActionCards.tsx` as Client Component
  - [ ] Accept props: `userId: string`, `currentDate: string`, `userBMR: number`
  - [ ] Set up state for loading and data: `const [loading, setLoading] = useState(true);`
  - [ ] Set up state: `const [calorieBalance, setCalorieBalance] = useState<number>(0);`
  - [ ] Set up state: `const [injectionCount, setInjectionCount] = useState<number>(0);`
  - [ ] Set up state: `const [nirvanaCount, setNirvanaCount] = useState<number>(0);`
  - [ ] Create Supabase client
  - [ ] Fetch data on mount (useEffect):
    - Query food_entries for today
    - Query exercise_entries for today
    - Calculate calorie balance (or set to 0 if tables don't exist yet)
    - Query injection_entries for past 7 days, count results
    - Query nirvana_sessions for current week, count results
    - Handle case where tables don't exist yet (gracefully default to 0)
  - [ ] Render 3-column responsive grid: `grid grid-cols-1 md:grid-cols-3 gap-6`
  - [ ] Render each card as clickable link using Next.js Link
  - [ ] Apply hover effects: `hover:scale-105 hover:border-primary transition-all duration-200`
  - [ ] Show skeleton loaders while loading

- [ ] Task 3: Create CalorieBalanceCard sub-component (AC: 3)
  - [ ] Create as separate component or inline in QuickActionCards
  - [ ] Display FireIcon from Heroicons
  - [ ] Display "Calorie Balance" title
  - [ ] Display balance with + or - sign
  - [ ] Color-code: `text-green-500` if positive, `text-red-500` if negative
  - [ ] Wrap in Link component pointing to `/calories`
  - [ ] Apply card-mm styling

- [ ] Task 4: Create InjectionsCard sub-component (AC: 4)
  - [ ] Display BeakerIcon from Heroicons
  - [ ] Display "Injections This Week" title
  - [ ] Display count: "{count} injections"
  - [ ] Wrap in Link component pointing to `/injections`
  - [ ] Apply card-mm styling

- [ ] Task 5: Create NirvanaCard sub-component (AC: 5)
  - [ ] Display UserIcon (or other appropriate icon) from Heroicons
  - [ ] Display "Nirvana Life" title
  - [ ] Display session count: "{completed}/7 sessions this week"
  - [ ] Wrap in Link component pointing to `/nirvana`
  - [ ] Apply card-mm styling

- [ ] Task 6: Handle graceful degradation for future features (AC: 3, 4, 5)
  - [ ] For calorie balance: If food_entries table doesn't exist, show "0 cal" or "â€”"
  - [ ] For injections: If injection_entries table doesn't exist, show "0 injections"
  - [ ] For nirvana: If nirvana_sessions table doesn't exist, show "0/7 sessions"
  - [ ] Log warnings (not errors) for missing tables
  - [ ] Add TODO comments indicating these will be populated in future epics

- [ ] Task 7: Integrate QuickActionCards into Daily Tracker page (AC: 1)
  - [ ] Import QuickActionCards in `app/daily/page.tsx`
  - [ ] Position below MITList and WeightEntry components
  - [ ] Pass props: userId, currentDate, userBMR (from profile)
  - [ ] Render in main layout grid

- [ ] Task 8: Add skeleton loading states (AC: 8)
  - [ ] Create skeleton component or use Tailwind utilities
  - [ ] Show 3 skeleton cards while data loads
  - [ ] Use `animate-pulse` class for loading animation
  - [ ] Replace with actual cards once data loaded

- [ ] Task 9: Write unit and integration tests (AC: all)
  - [ ] Test: calculateCalorieBalance returns correct value
  - [ ] Test: QuickActionCards renders 3 cards
  - [ ] Test: Cards display loading state initially
  - [ ] Test: CalorieBalance shows correct color for positive/negative
  - [ ] Test: Cards navigate to correct routes on click
  - [ ] Test: Hover effects apply correctly
  - [ ] Test: Graceful handling when data tables don't exist

## Dev Notes

### Previous Story Insights

From Story 2.1-2.5:
- Daily Tracker page layout established with grid system
- Server-side data fetching pattern for initial props
- Client-side data fetching in useEffect for dynamic data
- User profile data (BMR) available from server component

**Key Context:** This story creates navigation cards that summarize data from features not yet built (Calories, Injections, Nirvana from Epic 3+). The cards should gracefully show placeholder data (0 values) until those features exist.

### Data Models

**Food Entry** [Source: architecture/data-models.md#food-entry]
```typescript
export interface FoodEntry {
  id: string;
  user_id: string;
  date: string;
  time: string;
  name: string;
  calories: number;
  carbs: number;
  protein: number;
  fat: number;
  created_at: string;
}
```

**Exercise Entry** [Source: architecture/data-models.md#exercise-entry]
```typescript
export interface ExerciseEntry {
  id: string;
  user_id: string;
  date: string;
  time: string;
  activity: string;
  duration_minutes: number;
  calories_burned: number;
  created_at: string;
}
```

**Injection Entry** [Source: architecture/data-models.md#injection-entry]
```typescript
export interface InjectionEntry {
  id: string;
  user_id: string;
  compound_id: string;
  date: string;
  time: string;
  dosage: number;
  notes: string | null;
  created_at: string;
}
```

**Nirvana Session** [Source: architecture/data-models.md#nirvana-session]
```typescript
export interface NirvanaSession {
  id: string;
  user_id: string;
  session_type_id: string;
  date: string;
  completed_at: string;
  created_at: string;
}
```

**Important Note:** These tables do NOT exist yet in the database. They will be created in future epics. This story must handle their absence gracefully.

### Calculations Utility

**Calorie Balance Formula** [Source: architecture/frontend-architecture.md#service-example]

```typescript
// lib/services/calorie-balance.ts
import { Database } from '@/types/database.types';

type FoodEntry = Database['public']['Tables']['food_entries']['Row'];
type ExerciseEntry = Database['public']['Tables']['exercise_entries']['Row'];

interface CalorieBalanceParams {
  bmr: number;
  foodEntries: FoodEntry[];
  exerciseEntries: ExerciseEntry[];
}

export function calculateCalorieBalance({ bmr, foodEntries, exerciseEntries }: CalorieBalanceParams): number {
  const totalFoodCalories = foodEntries.reduce((sum, entry) => sum + entry.calories, 0);
  const totalExerciseCalories = exerciseEntries.reduce((sum, entry) => sum + entry.calories_burned, 0);

  // Balance = BMR - Food Consumed + Exercise Burned
  return bmr - totalFoodCalories + totalExerciseCalories;
}

export function getBalanceColor(balance: number): string {
  if (balance >= 0) return 'text-green-500'; // Surplus
  return 'text-red-500'; // Deficit
}
```

### Component Specifications

**QuickActionCards Component Pattern**

```typescript
'use client';

import { useState, useEffect } from 'react';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { Database } from '@/types/database.types';
import Link from 'next/link';
import { FireIcon, BeakerIcon, UserIcon } from '@heroicons/react/24/outline';

interface QuickActionCardsProps {
  userId: string;
  currentDate: string; // YYYY-MM-DD
  userBMR: number;
}

export default function QuickActionCards({ userId, currentDate, userBMR }: QuickActionCardsProps) {
  const supabase = createClientComponentClient<Database>();
  const [loading, setLoading] = useState(true);
  const [calorieBalance, setCalorieBalance] = useState(0);
  const [injectionCount, setInjectionCount] = useState(0);
  const [nirvanaCount, setNirvanaCount] = useState(0);

  useEffect(() => {
    async function fetchData() {
      try {
        // Calorie balance (tables may not exist yet)
        try {
          const [foodData, exerciseData] = await Promise.all([
            supabase.from('food_entries').select('calories').eq('user_id', userId).eq('date', currentDate),
            supabase.from('exercise_entries').select('calories_burned').eq('user_id', userId).eq('date', currentDate),
          ]);

          const totalFood = foodData.data?.reduce((sum, e) => sum + e.calories, 0) || 0;
          const totalExercise = exerciseData.data?.reduce((sum, e) => sum + e.calories_burned, 0) || 0;
          setCalorieBalance(userBMR - totalFood + totalExercise);
        } catch {
          // Table doesn't exist yet - default to 0
          setCalorieBalance(0);
        }

        // Injection count (past 7 days)
        try {
          const sevenDaysAgo = new Date(currentDate);
          sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

          const { data } = await supabase
            .from('injection_entries')
            .select('id')
            .eq('user_id', userId)
            .gte('date', sevenDaysAgo.toISOString().split('T')[0]);

          setInjectionCount(data?.length || 0);
        } catch {
          setInjectionCount(0);
        }

        // Nirvana sessions (current week)
        try {
          // Calculate week start (Monday)
          const weekStart = getWeekStartDate(new Date(currentDate), 'UTC');

          const { data } = await supabase
            .from('nirvana_sessions')
            .select('id')
            .eq('user_id', userId)
            .gte('date', weekStart);

          setNirvanaCount(data?.length || 0);
        } catch {
          setNirvanaCount(0);
        }
      } finally {
        setLoading(false);
      }
    }

    fetchData();
  }, [userId, currentDate, userBMR]);

  if (loading) {
    return (
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {[1, 2, 3].map((i) => (
          <div key={i} className="card-mm p-6 animate-pulse">
            <div className="h-16 w-16 bg-gray-700 rounded-full mb-4" />
            <div className="h-6 bg-gray-700 rounded w-3/4 mb-2" />
            <div className="h-8 bg-gray-700 rounded w-1/2" />
          </div>
        ))}
      </div>
    );
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
      {/* Calorie Balance Card */}
      <Link
        href="/calories"
        className="card-mm p-6 hover:scale-105 hover:border-primary transition-all duration-200 cursor-pointer"
      >
        <FireIcon className="w-16 h-16 text-orange-500 mb-4" />
        <h3 className="text-lg font-semibold mb-2">Calorie Balance</h3>
        <p className={`text-3xl font-bold ${calorieBalance >= 0 ? 'text-green-500' : 'text-red-500'}`}>
          {calorieBalance >= 0 ? '+' : ''}{calorieBalance} cal
        </p>
      </Link>

      {/* Injections Card */}
      <Link
        href="/injections"
        className="card-mm p-6 hover:scale-105 hover:border-primary transition-all duration-200 cursor-pointer"
      >
        <BeakerIcon className="w-16 h-16 text-blue-500 mb-4" />
        <h3 className="text-lg font-semibold mb-2">Injections This Week</h3>
        <p className="text-3xl font-bold">{injectionCount} injections</p>
      </Link>

      {/* Nirvana Card */}
      <Link
        href="/nirvana"
        className="card-mm p-6 hover:scale-105 hover:border-primary transition-all duration-200 cursor-pointer"
      >
        <UserIcon className="w-16 h-16 text-purple-500 mb-4" />
        <h3 className="text-lg font-semibold mb-2">Nirvana Life</h3>
        <p className="text-3xl font-bold">{nirvanaCount}/7 sessions</p>
      </Link>
    </div>
  );
}
```

### File Locations

[Source: architecture/unified-project-structure.md]

**Component Files:**
- Main: `components/daily/QuickActionCards.tsx`
- Type: React Client Component

**Utility Files:**
- Location: `lib/services/calorie-balance.ts` (or add to `lib/utils/calculations.ts`)
- Exports: `calculateCalorieBalance`, `getBalanceColor`

**Test Files:**
- Component tests: `tests/unit/components/QuickActionCards.test.tsx`
- Utility tests: `tests/unit/services/calorie-balance.test.ts`

### Technical Constraints

**Graceful Degradation** [Critical for this story]

Since the data tables for Calories, Injections, and Nirvana don't exist yet:

1. **Wrap queries in try-catch blocks**
   - Catch Supabase errors (table not found)
   - Default to 0 or placeholder values
   - Log warnings, not errors

2. **Use optional chaining and nullish coalescing**
   - `data?.length || 0`
   - `data?.reduce(...) ?? 0`

3. **Add TODO comments**
   ```typescript
   // TODO: This will be populated in Epic 3 (Calories Tracking)
   try {
     const foodData = await supabase.from('food_entries')...
   } catch {
     // Table doesn't exist yet - default to 0
     setCalorieBalance(0);
   }
   ```

**Navigation** [Source: architecture/frontend-architecture.md#routing-architecture]

Use Next.js Link component for client-side navigation:

```typescript
import Link from 'next/link';

<Link href="/calories" className="...">
  {/* Card content */}
</Link>
```

**Hover Effects:**
- Use Tailwind transitions: `transition-all duration-200`
- Scale on hover: `hover:scale-105`
- Border color change: `hover:border-primary`

### Naming Conventions

[Source: architecture/coding-standards.md]

- Component: `QuickActionCards.tsx` (PascalCase)
- Functions: `calculateCalorieBalance`, `getBalanceColor` (camelCase)
- File: `calorie-balance.ts` (kebab-case)

### Design System

**Card Grid:**
- Desktop: 3 columns (`grid-cols-3`)
- Tablet: 2 columns (`md:grid-cols-2` or stay at 3)
- Mobile: 1 column (`grid-cols-1`)
- Gap: `gap-6`

**Individual Cards:**
- Base: `card-mm p-6`
- Cursor: `cursor-pointer`
- Hover: `hover:scale-105 hover:border-primary`
- Transition: `transition-all duration-200`

**Icon Sizes:**
- Size: `w-16 h-16` (64px)
- Colors:
  - Fire (Calories): `text-orange-500`
  - Beaker (Injections): `text-blue-500`
  - User (Nirvana): `text-purple-500`

**Text Styles:**
- Title: `text-lg font-semibold mb-2`
- Value: `text-3xl font-bold`
- Calorie color: Dynamic based on positive/negative

**Skeleton Loader:**
- Use `animate-pulse` class
- Gray shapes: `bg-gray-700 rounded`
- Match layout of actual cards

### Testing

[Source: architecture/testing-strategy.md]

**Utility Tests** (`tests/unit/services/calorie-balance.test.ts`):

```typescript
describe('calculateCalorieBalance', () => {
  it('calculates balance correctly', () => {
    const params = {
      bmr: 2000,
      foodEntries: [
        { calories: 500, ... },
        { calories: 600, ... },
      ],
      exerciseEntries: [
        { calories_burned: 300, ... },
      ],
    };

    // 2000 - 1100 + 300 = 1200
    expect(calculateCalorieBalance(params)).toBe(1200);
  });

  it('handles empty entries', () => {
    const params = {
      bmr: 2000,
      foodEntries: [],
      exerciseEntries: [],
    };

    expect(calculateCalorieBalance(params)).toBe(2000);
  });
});

describe('getBalanceColor', () => {
  it('returns green for positive balance', () => {
    expect(getBalanceColor(500)).toBe('text-green-500');
    expect(getBalanceColor(0)).toBe('text-green-500');
  });

  it('returns red for negative balance', () => {
    expect(getBalanceColor(-100)).toBe('text-red-500');
  });
});
```

**Component Tests:**
- Renders 3 cards
- Shows loading state initially
- Displays correct data after loading
- Cards link to correct routes
- Hover effects apply
- Handles missing tables gracefully

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_This section will be populated by QA Agent after story completion._
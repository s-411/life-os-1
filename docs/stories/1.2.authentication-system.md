# Story 1.2: Authentication System Implementation

## Status

Approved

## Story

**As a** new user,
**I want** to sign up for an account and log in securely,
**so that** I can access my personal health tracking data.

## Acceptance Criteria

1. Sign up page created with email/password form using Supabase Auth
2. Email verification sent to new users (configurable via Supabase dashboard)
3. Login page created with email/password form
4. "Forgot Password" flow implemented (password reset email link)
5. OAuth integration available for Google and GitHub sign-in (optional but UI prepared)
6. Successful authentication redirects user to Daily Tracker (/daily)
7. Failed authentication displays clear error messages
8. User session persists across page reloads via Supabase auth state
9. Logout functionality clears session and redirects to login page
10. Protected routes middleware checks authentication status and redirects unauthenticated users to login

## Tasks / Subtasks

- [ ] Task 1: Create Sign Up page with email/password form (AC: 1, 2, 7)
  - [ ] Create src/app/(auth)/signup/page.tsx with signup form UI
  - [ ] Add email and password input fields with validation
  - [ ] Implement form submission handler using supabase.auth.signUp()
  - [ ] Display success message when signup successful
  - [ ] Display error messages for invalid email, weak password, or duplicate account
  - [ ] Configure email verification in Supabase dashboard settings
  - [ ] Test email verification flow end-to-end

- [ ] Task 2: Create Login page with email/password form (AC: 3, 6, 7, 8)
  - [ ] Create src/app/(auth)/login/page.tsx with login form UI
  - [ ] Add email and password input fields
  - [ ] Implement form submission handler using supabase.auth.signInWithPassword()
  - [ ] Redirect to /daily on successful login
  - [ ] Display error messages for invalid credentials or unverified email
  - [ ] Test session persistence by reloading page after login

- [ ] Task 3: Implement Forgot Password flow (AC: 4, 7)
  - [ ] Add "Forgot Password?" link on login page
  - [ ] Create src/app/(auth)/reset-password/page.tsx with email input form
  - [ ] Implement password reset request using supabase.auth.resetPasswordForEmail()
  - [ ] Display success message after reset email sent
  - [ ] Create password reset confirmation page for email link callback
  - [ ] Implement new password form and supabase.auth.updateUser() for password change
  - [ ] Test complete password reset flow

- [ ] Task 4: Add OAuth provider UI and configuration (AC: 5)
  - [ ] Add Google and GitHub OAuth buttons to signup and login pages
  - [ ] Implement OAuth handlers using supabase.auth.signInWithOAuth()
  - [ ] Configure OAuth redirect URLs in Supabase dashboard
  - [ ] Create src/app/(auth)/callback/route.ts to handle OAuth callbacks
  - [ ] Test OAuth flow for Google (if credentials available)
  - [ ] Add placeholder/disabled state if OAuth not yet configured

- [ ] Task 5: Create AuthContext for global auth state (AC: 8)
  - [ ] Create src/lib/context/AuthContext.tsx with React Context
  - [ ] Implement useAuth hook for accessing current user and session
  - [ ] Set up Supabase auth state listener (onAuthStateChange)
  - [ ] Provide user, session, loading state, and logout function
  - [ ] Wrap root layout with AuthProvider
  - [ ] Test auth state updates across page navigation

- [ ] Task 6: Implement logout functionality (AC: 9)
  - [ ] Add logout function to AuthContext using supabase.auth.signOut()
  - [ ] Create logout button in navigation/header component
  - [ ] Redirect to /login after successful logout
  - [ ] Clear any client-side cached data on logout
  - [ ] Test logout flow and verify session is cleared

- [ ] Task 7: Create authentication middleware for protected routes (AC: 10)
  - [ ] Create src/middleware.ts with Next.js middleware
  - [ ] Check authentication status using Supabase server client
  - [ ] Redirect unauthenticated users to /login for protected routes
  - [ ] Allow public access to /login, /signup, /reset-password
  - [ ] Test middleware by accessing /daily without authentication
  - [ ] Verify redirect preserves intended destination (return URL)

- [ ] Task 8: Create auth layout and styling (AC: 1, 3, 4, 5)
  - [ ] Create src/app/(auth)/layout.tsx with centered auth card design
  - [ ] Style forms with Tailwind CSS following design system
  - [ ] Add brand logo and tagline to auth pages
  - [ ] Implement responsive design for mobile and desktop
  - [ ] Add loading states and disabled states during form submission
  - [ ] Ensure WCAG accessibility standards (labels, focus states, error announcements)

## Dev Notes

**Relevant Tech Stack:**
- **Authentication**: Supabase Auth with email/password and OAuth providers
- **Framework**: Next.js 14 App Router with server and client components
- **State Management**: React Context for global auth state
- **Routing**: Next.js middleware for protected routes

**Authentication Architecture (from architecture docs):**
- **Supabase Auth** provides JWT-based authentication with automatic token refresh
- **Client-side auth**: Use `createClientComponentClient()` in React components
- **Server-side auth**: Use `createServerComponentClient()` in Server Components and API routes
- **Session management**: Supabase handles session storage in cookies automatically
- **Auth state**: Use `onAuthStateChange()` listener to sync auth state globally

**Project Structure:**
```
src/
├── app/
│   ├── (auth)/                     # Auth routes (no sidebar layout)
│   │   ├── layout.tsx              # Auth layout wrapper
│   │   ├── login/page.tsx          # Login page
│   │   ├── signup/page.tsx         # Sign up page
│   │   ├── reset-password/page.tsx # Password reset request
│   │   └── callback/route.ts       # OAuth callback handler
│   └── (app)/                      # Protected app routes (with sidebar)
│       └── daily/page.tsx          # Redirect destination after login
├── lib/
│   ├── supabase/
│   │   ├── client.ts               # Browser Supabase client
│   │   ├── server.ts               # Server Supabase client
│   │   └── middleware.ts           # Auth middleware helper
│   └── context/
│       └── AuthContext.tsx         # Global auth state provider
└── middleware.ts                   # Next.js middleware for route protection
```

**Critical Coding Standards:**
- **Error Handling**: Display user-friendly error messages for auth failures (invalid credentials, weak password, network errors)
- **Security**: Never log passwords or tokens; use HTTPS in production
- **Session Management**: Supabase handles token refresh automatically; trust the session state
- **Redirects**: Use Next.js `redirect()` from `next/navigation` for server-side redirects, `router.push()` for client-side

**Supabase Auth API Reference:**
- `supabase.auth.signUp({ email, password })` - Create new user account
- `supabase.auth.signInWithPassword({ email, password })` - Login with credentials
- `supabase.auth.signInWithOAuth({ provider })` - OAuth login (Google, GitHub)
- `supabase.auth.signOut()` - Logout and clear session
- `supabase.auth.resetPasswordForEmail(email)` - Send password reset email
- `supabase.auth.updateUser({ password })` - Update user password
- `supabase.auth.onAuthStateChange(callback)` - Listen for auth state changes
- `supabase.auth.getSession()` - Get current session (server-side)

**Design System Notes:**
- **Auth pages**: Centered card layout with dark background (#1a1a1a)
- **Forms**: Dark input fields with light borders, bright blue (#00A1FE) primary buttons
- **Error messages**: Red text (#EF4444) with icon, displayed below form fields
- **Success messages**: Green text (#10B981) with checkmark icon
- **Loading states**: Disable submit button and show spinner during auth operations

**Key Implementation Notes:**
- Use route groups `(auth)` and `(app)` to apply different layouts
- Email verification must be enabled in Supabase dashboard (Settings → Auth → Email Auth)
- OAuth providers require client IDs/secrets configured in Supabase dashboard
- Middleware runs on every request; keep it lightweight for performance
- Store intended destination URL in session/localStorage for post-login redirect

**Dependencies (should already be installed from Story 1.1):**
- `@supabase/supabase-js` for Supabase client
- `@supabase/auth-helpers-nextjs` for Next.js auth helpers (install if not present)

### Testing

**Test Location:**
- Unit tests: `tests/unit/context/AuthContext.test.tsx`
- Integration tests: `tests/integration/auth/`
- E2E tests: `tests/e2e/auth.spec.ts`

**Testing Requirements for Story 1.2:**

**Unit Tests:**
1. **AuthContext**: Test auth state updates, user object structure, logout function
2. **Form validation**: Test email format validation, password strength validation

**Integration Tests:**
1. **Sign up flow**: Mock Supabase signUp and verify form submission
2. **Login flow**: Mock signInWithPassword and verify redirect to /daily
3. **Password reset**: Mock resetPasswordForEmail and verify success message
4. **OAuth**: Mock signInWithOAuth and verify callback handling

**E2E Tests (Critical - Required for this story):**
1. **Complete sign up flow**:
   - Fill out signup form with valid email/password
   - Verify email verification sent (check inbox or mock)
   - Verify redirect or success message
2. **Complete login flow**:
   - Fill out login form with valid credentials
   - Verify redirect to /daily
   - Verify session persists on page reload
3. **Failed login**:
   - Attempt login with invalid credentials
   - Verify error message displays
4. **Logout flow**:
   - Log in, then click logout button
   - Verify redirect to /login
   - Verify accessing /daily redirects back to /login
5. **Protected route middleware**:
   - Attempt to access /daily without authentication
   - Verify redirect to /login

**Test Data:**
- Create test user account in Supabase for E2E tests (test@example.com)
- Use environment variable for test credentials: TEST_USER_EMAIL, TEST_USER_PASSWORD

**Key Testing Patterns:**
- Mock Supabase auth methods in unit/integration tests
- Use Playwright's `page.goto()`, `page.fill()`, `page.click()` for E2E flows
- Verify redirects with `page.waitForURL('/expected-path')`
- Check error messages with `expect(page.locator('text=Error message')).toBeVisible()`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation from Epic 1 | John (PM) |

## Dev Agent Record

#### Agent Model Used

_To be populated by dev agent during implementation_

#### Debug Log References

_To be populated by dev agent during implementation_

#### Completion Notes List

_To be populated by dev agent during implementation_

#### File List

_To be populated by dev agent during implementation_

## QA Results

_To be populated by QA agent after story completion_
# Story 2.3: Daily Weight Tracking with BMI Calculation

## Status

Draft

## Story

**As a** user,
**I want** to log my daily weight and see my BMI automatically calculated,
**so that** I can track my weight progress and understand my body composition.

## Acceptance Criteria

1. Supabase database table `daily_entries` created with schema:
   - `id` (UUID, primary key)
   - `user_id` (UUID, foreign key to auth.users, not null)
   - `date` (DATE, not null, unique per user)
   - `weight` (NUMERIC, nullable)
   - `deep_work_completed` (BOOLEAN, default false)
   - `winners_bible_morning` (BOOLEAN, default false)
   - `winners_bible_night` (BOOLEAN, default false)
   - `created_at` (TIMESTAMP)
   - `updated_at` (TIMESTAMP)
2. RLS policy: Users can CRUD only their own daily entries (user_id = auth.uid())
3. Unique constraint: (user_id, date) ensures one entry per day per user
4. "Weight Tracking" card displayed on Daily Tracker
5. Weight input field (number, step 0.1, placeholder "Enter today's weight (kg)")
6. Save button persists weight to `daily_entries.weight` for current date
7. BMI calculation displayed immediately after weight entered using formula: `BMI = weight(kg) / (height(m))²`
8. Height retrieved from user's profile (stored in cm, converted to m for calculation)
9. BMI displayed with 1 decimal precision (e.g., "BMI: 24.2")
10. BMI color-coded: Green (<25), Yellow (25-30), Red (>30)
11. Previously entered weight for the day pre-fills input field on page load
12. Toast notification on successful weight save

## Tasks / Subtasks

- [ ] Task 1: Create database migration for daily_entries table (AC: 1, 2, 3)
  - [ ] Create migration file `supabase/migrations/{timestamp}_create_daily_entries_table.sql`
  - [ ] Define `daily_entries` table with all required columns
  - [ ] Add unique constraint: `UNIQUE(user_id, date)`
  - [ ] Add index: `CREATE INDEX idx_daily_entries_user_date ON daily_entries(user_id, date);`
  - [ ] Enable Row Level Security
  - [ ] Create RLS policy "Users can manage own daily entries" with `USING (auth.uid() = user_id)`
  - [ ] Run migration: `supabase db push`
  - [ ] Verify table in Supabase dashboard

- [ ] Task 2: Generate TypeScript types for daily_entries (AC: 1)
  - [ ] Regenerate types: `supabase gen types typescript --local > src/types/database.types.ts`
  - [ ] Verify `DailyEntry` type available in `Database['public']['Tables']['daily_entries']['Row']`
  - [ ] Create type export in `src/types/index.ts`: `export type DailyEntry = Database['public']['Tables']['daily_entries']['Row'];`

- [ ] Task 3: Create BMI calculation utility (AC: 7)
  - [ ] Create or update file `lib/utils/calculations.ts`
  - [ ] Implement `calculateBMI(weightKg: number, heightCm: number): number` function
  - [ ] Formula: `weightKg / ((heightCm / 100) ** 2)`
  - [ ] Return BMI rounded to 1 decimal place
  - [ ] Handle edge cases: negative values, zero height
  - [ ] Write unit tests for BMI calculation with various inputs

- [ ] Task 4: Create BMI color coding utility (AC: 10)
  - [ ] Add `getBMIColor(bmi: number): string` function to `calculations.ts`
  - [ ] Return 'text-green-500' for BMI < 25
  - [ ] Return 'text-yellow-500' for BMI 25-30
  - [ ] Return 'text-red-500' for BMI > 30
  - [ ] Write unit tests for color coding boundaries

- [ ] Task 5: Create WeightEntry client component (AC: 4, 5, 6, 7, 8, 9, 10, 11, 12)
  - [ ] Create file `components/daily/WeightEntry.tsx` as Client Component
  - [ ] Accept props: `initialWeight: number | null`, `userHeight: number`, `userId: string`, `currentDate: string`
  - [ ] Set up state: `const [weight, setWeight] = useState<string>(initialWeight?.toString() || '');`
  - [ ] Set up state: `const [saving, setSaving] = useState(false);`
  - [ ] Create Supabase client using `createClientComponentClient<Database>()`
  - [ ] Calculate BMI whenever weight changes using `calculateBMI` utility
  - [ ] Implement saveWeight function:
    - Validate weight is a positive number
    - Check if daily_entry exists for current date (SELECT query)
    - If exists: UPDATE weight field
    - If not exists: INSERT new daily_entry with weight
    - Show toast notification on success
    - Handle errors gracefully
  - [ ] Render card with "Weight Tracking" heading
  - [ ] Render weight input (type="number", step="0.1", placeholder text)
  - [ ] Render Save button (disabled during save operation)
  - [ ] Display calculated BMI with color coding when weight > 0
  - [ ] Apply responsive styling

- [ ] Task 6: Integrate WeightEntry into Daily Tracker page (AC: 11)
  - [ ] Import WeightEntry component in `app/daily/page.tsx`
  - [ ] Fetch daily_entry for current date server-side
  - [ ] Query: `supabase.from('daily_entries').select('*').eq('user_id', user.id).eq('date', today).maybeSingle()`
  - [ ] Extract initial weight: `dailyEntryData.data?.weight`
  - [ ] Pass props to WeightEntry: initialWeight, userHeight (from profile), userId, currentDate
  - [ ] Position WeightEntry below MITList in layout grid

- [ ] Task 7: Add toast notification system (AC: 12)
  - [ ] Check if Toast component exists from Epic 1 in `components/ui/Toast.tsx`
  - [ ] If not, create simple Toast component with success/error variants
  - [ ] Use React state or library (react-hot-toast) for toast management
  - [ ] Show success toast: "Weight saved successfully!"
  - [ ] Show error toast on save failure with error message

- [ ] Task 8: Write unit and integration tests (AC: all)
  - [ ] Test: calculateBMI returns correct value (82kg, 180cm → 25.3)
  - [ ] Test: getBMIColor returns correct colors for boundaries (24.9, 25.0, 29.9, 30.0, 30.1)
  - [ ] Test: WeightEntry renders with initial weight pre-filled
  - [ ] Test: WeightEntry displays BMI after entering weight
  - [ ] Test: WeightEntry shows correct color for BMI value
  - [ ] Test: Save button calls Supabase INSERT when no entry exists
  - [ ] Test: Save button calls Supabase UPDATE when entry exists
  - [ ] Test: Toast notification appears on successful save
  - [ ] Test: RLS policy prevents cross-user access to daily_entries

## Dev Notes

### Previous Story Insights

From Story 2.1 (Daily Tracker Page Layout):
- Daily Tracker page shell exists with responsive grid layout
- Server-side user profile fetching implemented (height available)
- Current date in user's timezone calculated

From Story 2.2 (MITs System):
- Pattern established for client components with server-side initial data
- Supabase client patterns for INSERT/UPDATE operations
- Real-time subscriptions pattern (optional for this story)

**Key Context:** This story adds weight tracking functionality. The daily_entries table will also store other daily data (deep work, Winners Bible) in future stories.

### Data Models

**DailyEntry Table** [Source: architecture/data-models.md#daily-entry]

```typescript
export interface DailyEntry {
  id: string;
  user_id: string;
  date: string; // YYYY-MM-DD format
  weight: number | null;
  deep_work_completed: boolean;
  winners_bible_morning: boolean;
  winners_bible_night: boolean;
  created_at: string;
  updated_at: string;
}
```

**Database Schema** [Source: architecture/database-schema.md]

```sql
CREATE TABLE daily_entries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  weight NUMERIC CHECK (weight > 0),
  deep_work_completed BOOLEAN DEFAULT FALSE,
  winners_bible_morning BOOLEAN DEFAULT FALSE,
  winners_bible_night BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, date)
);

CREATE INDEX idx_daily_entries_user_date ON daily_entries(user_id, date);

ALTER TABLE daily_entries ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own daily entries" ON daily_entries
  USING (auth.uid() = user_id);
```

**Important Notes:**
- UNIQUE constraint on (user_id, date) ensures one entry per user per day
- Weight field is nullable - user may not enter weight every day
- CHECK constraint ensures weight > 0 if provided
- This table will be reused in Stories 2.4 (deep_work_completed) and future stories

### Component Specifications

**WeightEntry Component Pattern** [Source: architecture/frontend-architecture.md#component-template]

```typescript
'use client';

import { useState } from 'react';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { Database } from '@/types/database.types';
import { calculateBMI, getBMIColor } from '@/lib/utils/calculations';

interface WeightEntryProps {
  initialWeight: number | null;
  userHeight: number; // in cm
  userId: string;
  currentDate: string; // YYYY-MM-DD
}

export default function WeightEntry({ initialWeight, userHeight, userId, currentDate }: WeightEntryProps) {
  const supabase = createClientComponentClient<Database>();
  const [weight, setWeight] = useState<string>(initialWeight?.toString() || '');
  const [saving, setSaving] = useState(false);

  const weightNum = parseFloat(weight);
  const bmi = weightNum > 0 ? calculateBMI(weightNum, userHeight) : null;
  const bmiColor = bmi ? getBMIColor(bmi) : '';

  const saveWeight = async () => {
    // Implementation
  };

  return (
    <div className="card-mm p-6">
      {/* UI Implementation */}
    </div>
  );
}
```

### Calculations Utility

**BMI Formula** [Source: AC 7, Epic requirements]

```typescript
// lib/utils/calculations.ts

/**
 * Calculate Body Mass Index (BMI)
 * @param weightKg Weight in kilograms
 * @param heightCm Height in centimeters
 * @returns BMI rounded to 1 decimal place
 */
export function calculateBMI(weightKg: number, heightCm: number): number {
  if (weightKg <= 0 || heightCm <= 0) {
    throw new Error('Weight and height must be positive numbers');
  }

  const heightM = heightCm / 100;
  const bmi = weightKg / (heightM ** 2);

  return Math.round(bmi * 10) / 10; // Round to 1 decimal
}

/**
 * Get color class for BMI value based on health ranges
 * @param bmi BMI value
 * @returns Tailwind color class
 */
export function getBMIColor(bmi: number): string {
  if (bmi < 25) return 'text-green-500'; // Normal weight
  if (bmi < 30) return 'text-yellow-500'; // Overweight
  return 'text-red-500'; // Obese
}
```

**BMI Ranges (Standard WHO Guidelines):**
- Under 18.5: Underweight (not color-coded in AC but could be blue)
- 18.5-24.9: Normal weight (Green)
- 25-29.9: Overweight (Yellow)
- 30+: Obese (Red)

### File Locations

[Source: architecture/unified-project-structure.md]

**Component File:**
- Location: `components/daily/WeightEntry.tsx`
- Type: React Client Component

**Utility File:**
- Location: `lib/utils/calculations.ts`
- Exports: `calculateBMI`, `getBMIColor`

**Migration File:**
- Location: `supabase/migrations/{timestamp}_create_daily_entries_table.sql`

**Test Files:**
- Unit tests: `tests/unit/utils/calculations.test.ts`
- Component tests: `tests/unit/components/WeightEntry.test.tsx`
- Integration tests: `tests/integration/database/daily-entries-rls.test.ts`
- E2E test: `tests/e2e/daily-tracker.spec.ts` (add weight logging test)

### Technical Constraints

**Database Operations**

[Source: architecture/coding-standards.md#critical-fullstack-rules]

For saving weight, need to handle INSERT vs UPDATE:

```typescript
const saveWeight = async () => {
  setSaving(true);

  try {
    const weightNum = parseFloat(weight);

    // Check if entry exists
    const { data: existingEntry } = await supabase
      .from('daily_entries')
      .select('id')
      .eq('user_id', userId)
      .eq('date', currentDate)
      .maybeSingle();

    if (existingEntry) {
      // UPDATE existing entry
      const { error } = await supabase
        .from('daily_entries')
        .update({ weight: weightNum, updated_at: new Date().toISOString() })
        .eq('id', existingEntry.id);

      if (error) throw error;
    } else {
      // INSERT new entry
      const { error } = await supabase
        .from('daily_entries')
        .insert({
          user_id: userId,
          date: currentDate,
          weight: weightNum,
        });

      if (error) throw error;
    }

    // Show success toast
  } catch (error) {
    // Show error toast
  } finally {
    setSaving(false);
  }
};
```

**Alternative: Use Upsert**

Supabase supports UPSERT which is cleaner:

```typescript
const { error } = await supabase
  .from('daily_entries')
  .upsert({
    user_id: userId,
    date: currentDate,
    weight: weightNum,
    updated_at: new Date().toISOString(),
  }, {
    onConflict: 'user_id,date'
  });
```

**Recommended:** Use UPSERT approach for simplicity

### Naming Conventions

[Source: architecture/coding-standards.md#naming-conventions]

- Component: `WeightEntry.tsx` (PascalCase)
- Database table: `daily_entries` (snake_case)
- Database columns: `user_id`, `created_at`, `weight` (snake_case)
- TypeScript type: `DailyEntry` (PascalCase)
- Functions: `calculateBMI`, `saveWeight` (camelCase)

### Design System

**Card Styling:**
- Use `card-mm` class with padding `p-6`
- Section heading: `font-national2 text-2xl mb-4`

**Input Styling:**
- Type: `number` with `step="0.1"` for decimal precision
- Tailwind: `border rounded px-3 py-2 w-full`
- Or use `input-mm` class if defined in globals.css

**Button Styling:**
- Primary button: `btn-mm` or `bg-primary text-white px-4 py-2 rounded hover:bg-primary-dark`
- Disabled state: `opacity-50 cursor-not-allowed`

**BMI Display:**
- Text size: `text-lg` or `text-xl`
- Font weight: `font-semibold`
- Color: Dynamic based on `getBMIColor()` utility

### Testing

[Source: architecture/testing-strategy.md]

**Calculation Tests** (`tests/unit/utils/calculations.test.ts`):

```typescript
describe('calculateBMI', () => {
  it('calculates BMI correctly', () => {
    expect(calculateBMI(82, 180)).toBe(25.3); // 82 / (1.8^2) = 25.3
    expect(calculateBMI(70, 175)).toBe(22.9); // 70 / (1.75^2) = 22.86 → 22.9
  });

  it('throws error for invalid inputs', () => {
    expect(() => calculateBMI(0, 180)).toThrow();
    expect(() => calculateBMI(80, 0)).toThrow();
    expect(() => calculateBMI(-10, 180)).toThrow();
  });
});

describe('getBMIColor', () => {
  it('returns green for normal weight', () => {
    expect(getBMIColor(24.9)).toBe('text-green-500');
    expect(getBMIColor(20)).toBe('text-green-500');
  });

  it('returns yellow for overweight', () => {
    expect(getBMIColor(25)).toBe('text-yellow-500');
    expect(getBMIColor(29.9)).toBe('text-yellow-500');
  });

  it('returns red for obese', () => {
    expect(getBMIColor(30)).toBe('text-red-500');
    expect(getBMIColor(35)).toBe('text-red-500');
  });
});
```

**Component Tests** (`tests/unit/components/WeightEntry.test.tsx`):
- Renders with initial weight pre-filled
- Displays BMI after entering weight
- BMI color changes based on value
- Save button triggers Supabase upsert
- Toast appears on successful save
- Error handling for invalid weight values

**E2E Test** [Source: architecture/testing-strategy.md#e2e-test]:

```typescript
test('logs daily weight with BMI calculation', async ({ page }) => {
  await page.fill('input[placeholder="Enter today\'s weight (kg)"]', '82.5');
  await page.click('button:has-text("Save")');

  // Assuming user profile has height of 180cm
  // BMI = 82.5 / (1.8)^2 = 25.5
  await expect(page.locator('text=/BMI: 25.5/')).toBeVisible();
  await expect(page.locator('text=Weight saved successfully!')).toBeVisible();
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_This section will be populated by QA Agent after story completion._
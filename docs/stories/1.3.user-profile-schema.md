# Story 1.3: User Profile Schema & Management

## Status

Approved

## Story

**As an** authenticated user,
**I want** to create and manage my health profile with BMR, gender, height, and weight,
**so that** the application can personalize calculations and tracking.

## Acceptance Criteria

1. Supabase database table `profiles` created with schema:
   - `id` (UUID, primary key, foreign key to auth.users)
   - `bmr` (INTEGER, not null)
   - `gender` (TEXT, enum: 'male'|'female'|'other')
   - `height` (NUMERIC, in cm)
   - `weight` (NUMERIC, in kg)
   - `timezone` (TEXT)
   - `created_at` (TIMESTAMP)
   - `updated_at` (TIMESTAMP)
2. RLS policy: Users can only SELECT, UPDATE their own profile row (user_id = auth.uid())
3. First-time user redirected to profile setup wizard after sign-up
4. Profile setup form captures BMR, gender, height, weight, and timezone
5. BMR Calculator link provided for users who don't know their BMR
6. Profile data saved to Supabase `profiles` table via client mutation
7. TypeScript types defined for Profile interface matching database schema
8. Profile data fetched and displayed on Settings page for editing
9. Profile updates save successfully and show confirmation toast notification

## Tasks / Subtasks

- [ ] Task 1: Create database migration for profiles table (AC: 1)
  - [ ] Create new migration file: supabase/migrations/YYYYMMDDHHMMSS_create_profiles_table.sql
  - [ ] Write SQL to create profiles table with all required columns and constraints
  - [ ] Add foreign key constraint linking id to auth.users(id) with CASCADE delete
  - [ ] Add check constraint for gender enum ('male', 'female', 'other')
  - [ ] Add default timestamps (created_at, updated_at) with NOW() and trigger for updated_at
  - [ ] Run migration locally: `supabase db push`
  - [ ] Verify table created in Supabase dashboard

- [ ] Task 2: Create RLS policies for profiles table (AC: 2)
  - [ ] Enable RLS on profiles table: `ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;`
  - [ ] Create SELECT policy: Allow users to read their own profile (auth.uid() = id)
  - [ ] Create INSERT policy: Allow users to create their own profile on signup
  - [ ] Create UPDATE policy: Allow users to update only their own profile
  - [ ] Create DELETE policy: Allow users to delete their own profile (optional)
  - [ ] Test RLS policies by querying as different users
  - [ ] Document RLS policies in migration file with comments

- [ ] Task 3: Generate TypeScript types from database schema (AC: 7)
  - [ ] Run `supabase gen types typescript --local > src/types/database.types.ts`
  - [ ] Create src/types/index.ts with Profile interface exported
  - [ ] Verify Profile type includes all fields with correct types
  - [ ] Add JSDoc comments for Profile interface fields
  - [ ] Export Database type for use throughout application

- [ ] Task 4: Create profile setup wizard component (AC: 3, 4, 5)
  - [ ] Create src/components/onboarding/ProfileSetupWizard.tsx
  - [ ] Add form fields: BMR (number), gender (select), height (number), weight (number), timezone (select)
  - [ ] Add form validation: BMR required, height/weight positive numbers, gender required
  - [ ] Add "Calculate BMR" link that opens BMR calculator modal or navigates to /bmr-calculator
  - [ ] Implement form submission handler to insert profile data
  - [ ] Show loading state during submission
  - [ ] Redirect to /daily after successful profile creation
  - [ ] Display error messages for validation failures or database errors

- [ ] Task 5: Integrate profile setup into signup flow (AC: 3)
  - [ ] Check if user has profile after signup in AuthContext
  - [ ] Redirect to /onboarding/profile-setup if no profile exists
  - [ ] Create src/app/(app)/onboarding/profile-setup/page.tsx
  - [ ] Render ProfileSetupWizard component
  - [ ] Add middleware rule to allow /onboarding/profile-setup for authenticated users
  - [ ] Test complete flow: signup → profile setup → /daily

- [ ] Task 6: Create Settings page with profile editing (AC: 8, 9)
  - [ ] Create src/app/(app)/settings/page.tsx
  - [ ] Fetch current user profile on page load using Supabase client
  - [ ] Display profile data in editable form (same fields as setup wizard)
  - [ ] Implement update handler using supabase.from('profiles').update()
  - [ ] Show success toast notification after update (use ui/Toast.tsx component)
  - [ ] Show error toast if update fails
  - [ ] Add "Cancel" button to revert changes
  - [ ] Test profile updates and verify database changes

- [ ] Task 7: Create useProfile custom hook (AC: 6, 8)
  - [ ] Create src/lib/hooks/useProfile.ts
  - [ ] Implement hook to fetch profile data for current user
  - [ ] Return profile data, loading state, error state, and refetch function
  - [ ] Add updateProfile function to handle profile mutations
  - [ ] Use React Query or SWR for caching (optional, or use useState/useEffect)
  - [ ] Export hook for use in components

- [ ] Task 8: Create BMR Calculator utility and page (AC: 5)
  - [ ] Create src/lib/services/calculations.ts with calculateBMR function
  - [ ] Implement Mifflin-St Jeor equation: BMR = (10 × weight) + (6.25 × height) - (5 × age) + s
  - [ ] Create src/app/(app)/bmr-calculator/page.tsx with calculator form
  - [ ] Add inputs: age, gender, height, weight
  - [ ] Display calculated BMR result
  - [ ] Add "Use This BMR" button to auto-fill profile form
  - [ ] Test BMR calculation with known values

## Dev Notes

**Relevant Tech Stack:**
- **Database**: PostgreSQL via Supabase with RLS policies
- **Migration Tool**: Supabase CLI for SQL migrations
- **Type Generation**: Supabase CLI to auto-generate TypeScript types
- **State Management**: React hooks (useState, useEffect) or custom useProfile hook

**Database Schema (from architecture/database-schema.md):**
```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  bmr INTEGER NOT NULL,
  gender TEXT CHECK (gender IN ('male', 'female', 'other')),
  height NUMERIC(5,2) NOT NULL, -- in cm
  weight NUMERIC(5,2) NOT NULL, -- in kg
  timezone TEXT DEFAULT 'UTC',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- RLS Policies
CREATE POLICY "Users can view own profile"
  ON profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can insert own profile"
  ON profiles FOR INSERT
  WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON profiles FOR UPDATE
  USING (auth.uid() = id)
  WITH CHECK (auth.uid() = id);
```

**Critical Coding Standards:**
- **Database Queries**: Always filter by `user_id` to leverage RLS policies (even though RLS enforces this)
- **Type Safety**: Use auto-generated types from `database.types.ts` for all database operations
- **Timestamps**: Use TIMESTAMPTZ (UTC) in database, convert to user timezone only in UI
- **Validation**: Validate on both client-side (form) and server-side (database constraints)

**BMR Calculation Formula (Mifflin-St Jeor):**
- **Male**: BMR = (10 × weight in kg) + (6.25 × height in cm) - (5 × age in years) + 5
- **Female**: BMR = (10 × weight in kg) + (6.25 × height in cm) - (5 × age in years) - 161
- **Other**: Use average of male/female or allow user to specify

**RLS Policy Best Practices:**
- Always enable RLS on tables with user data
- Use `auth.uid()` to reference current authenticated user
- Test policies by switching between user accounts
- Document policy intent in SQL comments

**Supabase Migration Workflow:**
1. Create migration file: `supabase migration new create_profiles_table`
2. Write SQL in generated file
3. Apply locally: `supabase db push`
4. Generate types: `supabase gen types typescript --local > src/types/database.types.ts`
5. Commit migration file to version control
6. Deploy to production: Supabase CLI or dashboard

**Key Implementation Notes:**
- Profile setup wizard should be separate from Settings page (different use cases)
- Use toast notifications for success/error feedback (create reusable Toast component)
- Timezone will be fully implemented in Story 1.5, but include field in schema now
- Consider adding profile picture field for future enhancement (not required for this story)

### Testing

**Test Location:**
- Unit tests: `tests/unit/services/calculations.test.ts`, `tests/unit/hooks/useProfile.test.ts`
- Integration tests: `tests/integration/database/profiles-rls.test.ts`
- E2E tests: `tests/e2e/profile-setup.spec.ts`

**Testing Requirements for Story 1.3:**

**Unit Tests:**
1. **BMR Calculation**:
   - Test calculateBMR for male with known values
   - Test calculateBMR for female with known values
   - Test edge cases (zero values, negative values)
2. **useProfile Hook**:
   - Test profile data fetching
   - Test updateProfile function
   - Test loading and error states

**Integration Tests:**
1. **RLS Policies**:
   - Verify User A cannot read User B's profile
   - Verify User A can read/update their own profile
   - Verify unauthenticated requests are blocked
2. **Profile CRUD**:
   - Test profile creation on signup
   - Test profile updates
   - Test profile deletion (if implemented)

**E2E Tests (Critical - Required):**
1. **Complete profile setup flow**:
   - Sign up new user
   - Verify redirect to profile setup wizard
   - Fill out profile form with valid data
   - Submit and verify redirect to /daily
   - Navigate to Settings and verify profile data displayed
2. **Profile update flow**:
   - Log in as existing user
   - Navigate to Settings
   - Update profile fields (change weight, BMR)
   - Save and verify success toast
   - Reload page and verify updated data persists
3. **BMR calculator**:
   - Navigate to BMR calculator page
   - Enter age, gender, height, weight
   - Verify BMR calculated correctly
   - Click "Use This BMR" and verify profile form auto-fills

**Test Data:**
- Test user profile: BMR=2000, gender='male', height=180, weight=80, timezone='America/New_York'
- BMR test cases: Male 30yo, 180cm, 80kg → 1835 BMR

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation from Epic 1 | John (PM) |

## Dev Agent Record

#### Agent Model Used

_To be populated by dev agent during implementation_

#### Debug Log References

_To be populated by dev agent during implementation_

#### Completion Notes List

_To be populated by dev agent during implementation_

#### File List

_To be populated by dev agent during implementation_

## QA Results

_To be populated by QA agent after story completion_
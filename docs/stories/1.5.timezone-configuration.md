# Story 1.5: Timezone Configuration & Date Utilities

## Status

Approved

## Story

**As a** user,
**I want** to configure my timezone so days change at midnight in my local time,
**so that** my daily tracking accurately reflects my schedule.

## Acceptance Criteria

1. Timezone selector added to profile setup and Settings page
2. Dropdown populated with common timezones (at least 20 major cities/regions)
3. Selected timezone saved to `profiles.timezone` column in Supabase
4. Utility function created to get current date in user's timezone
5. Utility function created to convert UTC timestamps to user's local time
6. Date utilities use date-fns with timezone support (date-fns-tz)
7. All date displays throughout app use user's configured timezone
8. Default timezone set to browser timezone if user hasn't configured one
9. Settings page shows current time in user's selected timezone as preview

## Tasks / Subtasks

- [ ] Task 1: Install and configure date-fns-tz (AC: 6)
  - [ ] Install date-fns-tz: `npm install date-fns-tz`
  - [ ] Verify date-fns is already installed (from Story 1.1)
  - [ ] Create src/lib/utils/date.ts for timezone utilities
  - [ ] Import required functions: format, formatInTimeZone, utcToZonedTime, zonedTimeToUtc
  - [ ] Test imports work correctly

- [ ] Task 2: Create timezone list constant (AC: 2)
  - [ ] Create src/lib/constants/timezones.ts
  - [ ] Define TIMEZONES array with at least 20 common timezones:
    - Americas: America/New_York, America/Chicago, America/Denver, America/Los_Angeles, America/Toronto, America/Mexico_City, America/Sao_Paulo
    - Europe: Europe/London, Europe/Paris, Europe/Berlin, Europe/Madrid, Europe/Rome, Europe/Amsterdam
    - Asia: Asia/Tokyo, Asia/Shanghai, Asia/Singapore, Asia/Dubai, Asia/Kolkata
    - Oceania: Australia/Sydney, Pacific/Auckland
    - Africa: Africa/Johannesburg, Africa/Cairo
  - [ ] Format: `{ value: 'America/New_York', label: 'Eastern Time (New York)' }`
  - [ ] Sort timezones alphabetically by region/city

- [ ] Task 3: Create date utility functions (AC: 4, 5, 7)
  - [ ] Create getCurrentDateInTimezone(timezone: string): Date function
  - [ ] Create formatDateInTimezone(date: Date, timezone: string, formatStr: string): string
  - [ ] Create convertUTCToTimezone(utcDate: Date, timezone: string): Date
  - [ ] Create getDayStartInTimezone(timezone: string): Date (midnight in user's timezone)
  - [ ] Create getDayEndInTimezone(timezone: string): Date (23:59:59 in user's timezone)
  - [ ] Add JSDoc comments for each function with examples
  - [ ] Export all functions from date.ts

- [ ] Task 4: Create getBrowserTimezone utility (AC: 8)
  - [ ] Add getBrowserTimezone(): string function to date.ts
  - [ ] Use Intl.DateTimeFormat().resolvedOptions().timeZone
  - [ ] Add fallback to 'UTC' if browser timezone unavailable
  - [ ] Test in different browsers (Chrome, Firefox, Safari)

- [ ] Task 5: Add timezone selector to ProfileSetupWizard (AC: 1, 3)
  - [ ] Update src/components/onboarding/ProfileSetupWizard.tsx
  - [ ] Import TIMEZONES from constants
  - [ ] Add timezone dropdown field (select element or Headless UI Listbox)
  - [ ] Set default value to getBrowserTimezone()
  - [ ] Save timezone to profiles.timezone on form submission
  - [ ] Test profile creation includes timezone

- [ ] Task 6: Add timezone selector to Settings page (AC: 1, 3, 9)
  - [ ] Update src/app/(app)/settings/page.tsx
  - [ ] Add timezone dropdown to profile edit form
  - [ ] Display current timezone value from user profile
  - [ ] Add "Current time preview" display showing current time in selected timezone
  - [ ] Update preview in real-time when timezone changes (before save)
  - [ ] Save updated timezone to profiles.timezone on form submission
  - [ ] Test timezone updates and verify preview works

- [ ] Task 7: Create useTimezone custom hook (AC: 7, 8)
  - [ ] Create src/lib/hooks/useTimezone.ts
  - [ ] Fetch user's timezone from profile (or use browser timezone as default)
  - [ ] Return timezone string and utility functions bound to user's timezone
  - [ ] Export hook: `const { timezone, formatDate, getCurrentDate } = useTimezone()`
  - [ ] Add loading state while fetching user profile
  - [ ] Test hook in a component

- [ ] Task 8: Update existing date displays to use timezone (AC: 7)
  - [ ] Audit codebase for any hardcoded date formatting
  - [ ] Replace `new Date()` with `getCurrentDateInTimezone(userTimezone)`
  - [ ] Replace date formatting with `formatDateInTimezone()` utility
  - [ ] Update any date comparisons to account for timezone (day boundaries)
  - [ ] Test date displays in different timezones (try America/Los_Angeles vs Asia/Tokyo)
  - [ ] Verify daily tracking respects user's midnight (not UTC midnight)

## Dev Notes

**Relevant Tech Stack:**
- **Date Library**: date-fns 3.0+ with date-fns-tz for timezone support
- **Browser API**: Intl.DateTimeFormat for detecting browser timezone
- **Storage**: User timezone stored in profiles.timezone (Supabase)

**Timezone Handling Philosophy:**
- **Database**: Store all timestamps as TIMESTAMPTZ (UTC) in PostgreSQL
- **Display**: Convert to user's timezone only in UI layer
- **Day Boundaries**: Use user's timezone to determine day start/end for daily tracking
- **Default**: Use browser timezone if user hasn't configured one

**Date-fns-tz Key Functions:**
```typescript
import { formatInTimeZone, utcToZonedTime, zonedTimeToUtc } from 'date-fns-tz';
import { format } from 'date-fns';

// Get current date/time in specific timezone
const now = new Date();
const zonedDate = utcToZonedTime(now, 'America/New_York');

// Format date in specific timezone
const formatted = formatInTimeZone(now, 'America/New_York', 'yyyy-MM-dd HH:mm:ss zzz');
// Output: "2025-01-30 15:30:00 EST"

// Convert zoned time back to UTC
const utcDate = zonedTimeToUtc(zonedDate, 'America/New_York');
```

**Common Date Format Patterns:**
- Full date: `'EEEE, MMMM d, yyyy'` → "Friday, January 30, 2025"
- Short date: `'MMM d, yyyy'` → "Jan 30, 2025"
- Date with time: `'MMM d, yyyy h:mm a'` → "Jan 30, 2025 3:30 PM"
- Time only: `'h:mm a'` → "3:30 PM"
- ISO date: `'yyyy-MM-dd'` → "2025-01-30"

**Critical Date Utility Functions:**

```typescript
// src/lib/utils/date.ts

import { formatInTimeZone, utcToZonedTime } from 'date-fns-tz';

/**
 * Get current date in user's timezone
 */
export function getCurrentDateInTimezone(timezone: string): Date {
  return utcToZonedTime(new Date(), timezone);
}

/**
 * Get start of day (midnight) in user's timezone
 */
export function getDayStartInTimezone(timezone: string): Date {
  const now = utcToZonedTime(new Date(), timezone);
  now.setHours(0, 0, 0, 0);
  return now;
}

/**
 * Format date in user's timezone
 */
export function formatDateInTimezone(
  date: Date,
  timezone: string,
  formatStr: string = 'MMM d, yyyy h:mm a'
): string {
  return formatInTimeZone(date, timezone, formatStr);
}

/**
 * Get browser's timezone
 */
export function getBrowserTimezone(): string {
  try {
    return Intl.DateTimeFormat().resolvedOptions().timeZone;
  } catch {
    return 'UTC';
  }
}
```

**Timezone Selector Component:**
```typescript
<select
  value={selectedTimezone}
  onChange={(e) => setSelectedTimezone(e.target.value)}
  className="..."
>
  {TIMEZONES.map(tz => (
    <option key={tz.value} value={tz.value}>
      {tz.label}
    </option>
  ))}
</select>
```

**Key Implementation Notes:**
- Always store dates in UTC in database (PostgreSQL TIMESTAMPTZ)
- Convert to user's timezone only when displaying
- Use user's timezone to determine daily tracking boundaries (midnight to midnight in their time)
- Profile setup should default to browser timezone (good UX)
- Settings page timezone preview helps users verify selection

**Common Timezone Pitfalls:**
- Don't use JavaScript Date objects for date-only comparisons (they include time)
- Remember daylight saving time shifts affect timezone offsets
- Test with timezones that cross date boundaries (e.g., UTC+14 vs UTC-11)
- Use IANA timezone names (e.g., 'America/New_York') not abbreviations (e.g., 'EST')

### Testing

**Test Location:**
- Unit tests: `tests/unit/utils/date.test.ts`
- Integration tests: `tests/integration/timezone/`
- E2E tests: `tests/e2e/timezone-configuration.spec.ts`

**Testing Requirements for Story 1.5:**

**Unit Tests (Critical):**
1. **Date Utility Functions**:
   - Test getCurrentDateInTimezone returns correct date for different timezones
   - Test getDayStartInTimezone returns midnight in user's timezone
   - Test formatDateInTimezone formats correctly with various format strings
   - Test getBrowserTimezone returns valid timezone string
   - Test timezone conversion edge cases (DST transitions, year boundaries)
2. **Timezone Constants**:
   - Verify TIMEZONES array has at least 20 entries
   - Verify all timezone values are valid IANA timezone names
   - Test timezone labels are user-friendly

**Integration Tests:**
1. **Profile Timezone Updates**:
   - Create profile with timezone and verify saved to database
   - Update timezone and verify change persisted
   - Fetch profile and verify timezone returned correctly
2. **Date Queries with Timezone**:
   - Query data for "today" in user's timezone
   - Verify correct data returned based on timezone day boundaries
   - Test with users in different timezones (US vs Asia vs Europe)

**E2E Tests (Required):**
1. **Profile setup with timezone**:
   - Start profile setup wizard
   - Verify timezone dropdown shows browser timezone as default
   - Select different timezone from dropdown
   - Submit form and verify timezone saved
2. **Settings timezone update**:
   - Navigate to Settings page
   - Verify current timezone displayed
   - Change timezone to different value
   - Verify current time preview updates immediately
   - Save changes and verify timezone persisted
   - Reload page and verify new timezone displayed
3. **Date display in different timezones**:
   - Set user timezone to 'America/Los_Angeles' (UTC-8)
   - Log data at 11:30 PM PST
   - Verify data shows in today's list (not tomorrow's)
   - Change timezone to 'Asia/Tokyo' (UTC+9)
   - Verify same data now shows in different date bucket (day boundary shifted)

**Test Data:**
- Test timezones: 'America/New_York' (UTC-5), 'Europe/London' (UTC+0), 'Asia/Tokyo' (UTC+9)
- Test dates near midnight to verify day boundary logic
- Test dates during DST transitions (March/November for US timezones)

**Edge Cases to Test:**
- User in UTC+14 timezone (earliest timezone)
- User in UTC-11 timezone (latest timezone)
- Date formatting on year boundary (Dec 31 → Jan 1)
- Daylight saving time transitions
- Browser without Intl API support (fallback to UTC)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation from Epic 1 | John (PM) |

## Dev Agent Record

#### Agent Model Used

_To be populated by dev agent during implementation_

#### Debug Log References

_To be populated by dev agent during implementation_

#### Completion Notes List

_To be populated by dev agent during implementation_

#### File List

_To be populated by dev agent during implementation_

## QA Results

_To be populated by QA agent after story completion_
# Story 2.4: Deep Work Session Tracking

## Status

Draft

## Story

**As a** user,
**I want** to mark when I've completed my deep work session for the day,
**so that** I can track my productivity consistency.

## Acceptance Criteria

1. "Deep Work Session" card displayed on Daily Tracker
2. Large checkbox labeled "Deep Work Session Completed"
3. Checkbox state bound to `daily_entries.deep_work_completed` for current date
4. Clicking checkbox toggles state and saves to Supabase immediately
5. Completed state shows checkmark with green background
6. Incomplete state shows empty checkbox with gray background
7. Checkbox state persists across page reloads
8. If no daily_entry exists for current date, creating one when checkbox toggled

## Tasks / Subtasks

- [ ] Task 1: Verify daily_entries table from Story 2.3 (AC: 3, 8)
  - [ ] Confirm `daily_entries` table exists with `deep_work_completed` boolean field
  - [ ] Confirm RLS policies allow INSERT/UPDATE operations
  - [ ] No new migration needed - table created in Story 2.3

- [ ] Task 2: Create DeepWorkTracker client component (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Create file `components/daily/DeepWorkTracker.tsx` as Client Component
  - [ ] Accept props: `initialCompleted: boolean`, `userId: string`, `currentDate: string`
  - [ ] Set up state: `const [completed, setCompleted] = useState<boolean>(initialCompleted);`
  - [ ] Set up state: `const [saving, setSaving] = useState(false);`
  - [ ] Create Supabase client using `createClientComponentClient<Database>()`
  - [ ] Implement toggleDeepWork function:
    - Optimistically update local state immediately
    - Use UPSERT to save to `daily_entries` table
    - Handle case where entry doesn't exist (INSERT with deep_work_completed: true)
    - Handle case where entry exists (UPDATE deep_work_completed field)
    - Show toast on error (optional: silent success)
  - [ ] Render card with "Deep Work Session" heading
  - [ ] Render large checkbox (custom styled or Headless UI)
  - [ ] Apply green background (`bg-green-500`) when completed
  - [ ] Apply gray background (`bg-gray-300`) when incomplete
  - [ ] Show checkmark icon when completed (Heroicons CheckIcon)
  - [ ] Add hover effects and transition animations

- [ ] Task 3: Integrate DeepWorkTracker into Daily Tracker page (AC: 7)
  - [ ] Import DeepWorkTracker in `app/daily/page.tsx`
  - [ ] Use existing dailyEntry data fetch from Story 2.3
  - [ ] Extract initial state: `dailyEntryData.data?.deep_work_completed || false`
  - [ ] Pass props: initialCompleted, userId, currentDate
  - [ ] Position DeepWorkTracker in layout grid (below WeightEntry or alongside)

- [ ] Task 4: Add styling for checkbox component (AC: 5, 6)
  - [ ] Create large checkbox (64px x 64px or 80px x 80px)
  - [ ] Use flexbox centering for checkmark icon
  - [ ] Completed: `bg-green-500 border-green-600`
  - [ ] Incomplete: `bg-gray-200 border-gray-400`
  - [ ] Add hover effect: slight scale and shadow
  - [ ] Add transition: `transition-all duration-200 ease-in-out`
  - [ ] Cursor: `cursor-pointer`
  - [ ] Ensure accessibility: `role="checkbox"`, `aria-checked` attribute

- [ ] Task 5: Write unit and integration tests (AC: all)
  - [ ] Test: DeepWorkTracker renders with initial state
  - [ ] Test: Clicking checkbox toggles completed state
  - [ ] Test: UPSERT called with correct data on toggle
  - [ ] Test: Optimistic update happens immediately
  - [ ] Test: Completed state shows green background
  - [ ] Test: Incomplete state shows gray background
  - [ ] Test: Checkbox accessible via keyboard (Space key)
  - [ ] Test: State persists after page reload (integration)

## Dev Notes

### Previous Story Insights

From Story 2.3 (Daily Weight Tracking with BMI):
- `daily_entries` table already created with `deep_work_completed` field
- UPSERT pattern established for daily_entries (onConflict: 'user_id,date')
- Server-side fetch of dailyEntry data already implemented in Daily Tracker page

**Key Context:** This story reuses the daily_entries infrastructure from Story 2.3. No new database changes needed. Focus is on creating a simple, satisfying checkbox interaction.

### Data Models

**DailyEntry Table** [Source: architecture/data-models.md#daily-entry]

The `deep_work_completed` field was defined in Story 2.3:

```typescript
export interface DailyEntry {
  id: string;
  user_id: string;
  date: string;
  weight: number | null;
  deep_work_completed: boolean; // ← This story uses this field
  winners_bible_morning: boolean;
  winners_bible_night: boolean;
  created_at: string;
  updated_at: string;
}
```

**Database Schema:**
```sql
-- From Story 2.3 migration
CREATE TABLE daily_entries (
  ...
  deep_work_completed BOOLEAN DEFAULT FALSE,
  ...
);
```

### Component Specifications

**DeepWorkTracker Component Pattern**

```typescript
'use client';

import { useState } from 'react';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { Database } from '@/types/database.types';
import { CheckIcon } from '@heroicons/react/24/solid';

interface DeepWorkTrackerProps {
  initialCompleted: boolean;
  userId: string;
  currentDate: string; // YYYY-MM-DD
}

export default function DeepWorkTracker({
  initialCompleted,
  userId,
  currentDate,
}: DeepWorkTrackerProps) {
  const supabase = createClientComponentClient<Database>();
  const [completed, setCompleted] = useState(initialCompleted);
  const [saving, setSaving] = useState(false);

  const toggleDeepWork = async () => {
    // Optimistic update
    const newCompleted = !completed;
    setCompleted(newCompleted);

    setSaving(true);
    try {
      const { error } = await supabase
        .from('daily_entries')
        .upsert(
          {
            user_id: userId,
            date: currentDate,
            deep_work_completed: newCompleted,
            updated_at: new Date().toISOString(),
          },
          { onConflict: 'user_id,date' }
        );

      if (error) {
        // Revert on error
        setCompleted(!newCompleted);
        console.error('Error saving deep work:', error);
      }
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="card-mm p-6">
      <h2 className="text-2xl font-national2 mb-4">Deep Work Session</h2>

      <div
        className={`
          w-20 h-20 rounded-lg flex items-center justify-center cursor-pointer
          transition-all duration-200 ease-in-out
          ${completed ? 'bg-green-500 border-2 border-green-600' : 'bg-gray-200 border-2 border-gray-400'}
          hover:scale-105 hover:shadow-lg
          ${saving ? 'opacity-50 cursor-wait' : ''}
        `}
        onClick={toggleDeepWork}
        role="checkbox"
        aria-checked={completed}
        aria-label="Deep Work Session Completed"
        tabIndex={0}
        onKeyDown={(e) => e.key === ' ' && toggleDeepWork()}
      >
        {completed && <CheckIcon className="w-12 h-12 text-white" />}
      </div>

      <p className="mt-3 text-sm text-gray-400">
        {completed ? 'Completed today ✓' : 'Click to mark complete'}
      </p>
    </div>
  );
}
```

### File Locations

[Source: architecture/unified-project-structure.md]

**Component File:**
- Location: `components/daily/DeepWorkTracker.tsx`
- Type: React Client Component

**Page Integration:**
- Location: `app/daily/page.tsx` (modify existing)
- Import DeepWorkTracker and add to page layout

**Test Files:**
- Component tests: `tests/unit/components/DeepWorkTracker.test.tsx`
- E2E test: `tests/e2e/daily-tracker.spec.ts` (add deep work test)

### Technical Constraints

**UPSERT Pattern** [Source: Story 2.3 learnings]

Use the same UPSERT pattern from Story 2.3:

```typescript
await supabase
  .from('daily_entries')
  .upsert(
    {
      user_id: userId,
      date: currentDate,
      deep_work_completed: newCompleted,
      updated_at: new Date().toISOString(),
    },
    { onConflict: 'user_id,date' }
  );
```

**Optimistic Updates** [Source: architecture/frontend-architecture.md#state-management-patterns]

Update UI immediately, then save to server:
1. User clicks checkbox
2. Immediately update local state (instant feedback)
3. Send request to Supabase
4. On error, revert local state
5. No toast needed for success (silent success pattern for simple toggles)

**Accessibility Requirements:**
- Use semantic `role="checkbox"`
- Add `aria-checked` attribute
- Support keyboard interaction (Space key to toggle)
- Add `tabIndex={0}` for keyboard focus
- Provide `aria-label` for screen readers

### Naming Conventions

[Source: architecture/coding-standards.md#naming-conventions]

- Component: `DeepWorkTracker.tsx` (PascalCase)
- Function: `toggleDeepWork` (camelCase)
- Database field: `deep_work_completed` (snake_case)

### Design System

**Card Styling:**
- Use `card-mm` class with padding
- Heading: `font-national2 text-2xl`

**Checkbox Styling:**
- Size: `w-20 h-20` (80px x 80px) for easy clicking
- Border radius: `rounded-lg`
- Completed: `bg-green-500 border-2 border-green-600`
- Incomplete: `bg-gray-200 border-2 border-gray-400`
- Hover: `hover:scale-105 hover:shadow-lg`
- Transition: `transition-all duration-200 ease-in-out`

**Icon:**
- Heroicons `CheckIcon` (solid variant)
- Size: `w-12 h-12`
- Color: `text-white`

**Label Text:**
- Size: `text-sm`
- Color: `text-gray-400`
- Completed message: "Completed today ✓"
- Incomplete message: "Click to mark complete"

### Testing

[Source: architecture/testing-strategy.md]

**Component Tests** (`tests/unit/components/DeepWorkTracker.test.tsx`):

```typescript
describe('DeepWorkTracker', () => {
  const mockSupabase = {
    from: jest.fn(() => ({
      upsert: jest.fn(() => Promise.resolve({ error: null })),
    })),
  };

  beforeEach(() => {
    (createClientComponentClient as jest.Mock).mockReturnValue(mockSupabase);
  });

  it('renders with initial completed state', () => {
    render(<DeepWorkTracker initialCompleted={true} userId="user1" currentDate="2025-01-30" />);
    expect(screen.getByRole('checkbox')).toHaveAttribute('aria-checked', 'true');
    expect(screen.getByText('Completed today ✓')).toBeInTheDocument();
  });

  it('renders with initial incomplete state', () => {
    render(<DeepWorkTracker initialCompleted={false} userId="user1" currentDate="2025-01-30" />);
    expect(screen.getByRole('checkbox')).toHaveAttribute('aria-checked', 'false');
    expect(screen.getByText('Click to mark complete')).toBeInTheDocument();
  });

  it('toggles state on click', async () => {
    render(<DeepWorkTracker initialCompleted={false} userId="user1" currentDate="2025-01-30" />);

    const checkbox = screen.getByRole('checkbox');
    fireEvent.click(checkbox);

    await waitFor(() => {
      expect(checkbox).toHaveAttribute('aria-checked', 'true');
    });

    expect(mockSupabase.from).toHaveBeenCalledWith('daily_entries');
  });

  it('supports keyboard interaction', async () => {
    render(<DeepWorkTracker initialCompleted={false} userId="user1" currentDate="2025-01-30" />);

    const checkbox = screen.getByRole('checkbox');
    fireEvent.keyDown(checkbox, { key: ' ' });

    await waitFor(() => {
      expect(checkbox).toHaveAttribute('aria-checked', 'true');
    });
  });
});
```

**E2E Test** (`tests/e2e/daily-tracker.spec.ts`):

```typescript
test('marks deep work session as complete', async ({ page }) => {
  await page.goto('/daily');

  const deepWorkCheckbox = page.locator('[aria-label="Deep Work Session Completed"]');

  // Initially incomplete
  await expect(deepWorkCheckbox).toHaveAttribute('aria-checked', 'false');

  // Click to complete
  await deepWorkCheckbox.click();

  // Verify completed state
  await expect(deepWorkCheckbox).toHaveAttribute('aria-checked', 'true');
  await expect(page.locator('text=Completed today ✓')).toBeVisible();

  // Reload page to verify persistence
  await page.reload();
  await expect(deepWorkCheckbox).toHaveAttribute('aria-checked', 'true');
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_This section will be populated by QA Agent after story completion._
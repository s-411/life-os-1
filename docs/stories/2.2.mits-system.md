# Story 2.2: MITs (Most Important Things) System

## Status

Draft

## Story

**As a** user,
**I want** to add up to 3 Most Important Things for each day and mark them complete,
**so that** I can focus on my top priorities and track my daily accomplishments.

## Acceptance Criteria

1. Supabase database table `mits` created with schema:
   - `id` (UUID, primary key)
   - `user_id` (UUID, foreign key to auth.users, not null)
   - `date` (DATE, not null)
   - `title` (TEXT, not null)
   - `completed` (BOOLEAN, default false)
   - `completed_at` (TIMESTAMP, nullable)
   - `created_at` (TIMESTAMP)
   - `updated_at` (TIMESTAMP)
2. RLS policy: Users can CRUD only their own MITs (user_id = auth.uid())
3. Unique constraint: (user_id, date, title) to prevent duplicate MITs
4. Daily Tracker displays "Today's MITs" section with card styling
5. Add MIT form with single text input (placeholder: "What's most important today?")
6. Add button disabled when 3 MITs already exist for the day
7. Each MIT displayed with checkbox and title text
8. Clicking checkbox toggles completed status and saves to Supabase
9. Completed MITs show with strikethrough text and faded appearance
10. Delete button (×) on each MIT to remove it
11. MITs load from Supabase for current date on page load
12. Empty state message displayed when no MITs exist: "Add your first MIT to focus on what matters most today."

## Tasks / Subtasks

- [ ] Task 1: Create database migration for mits table (AC: 1, 2, 3)
  - [ ] Create migration file in `supabase/migrations/` following naming convention `YYYYMMDDHHMMSS_create_mits_table.sql`
  - [ ] Define `mits` table with all required columns matching schema
  - [ ] Add indexes: `idx_mits_user_date ON mits(user_id, date)` for query performance
  - [ ] Enable Row Level Security on `mits` table
  - [ ] Create RLS policy "Users can manage own mits" with condition `auth.uid() = user_id`
  - [ ] Add unique constraint (user_id, date, title) - NOTE: This differs from Epic (Epic says unique, but likely should allow same title on different dates)
  - [ ] Run migration using Supabase CLI: `supabase db push`
  - [ ] Verify table creation in Supabase dashboard

- [ ] Task 2: Generate TypeScript types for mits table (AC: 1)
  - [ ] Run `supabase gen types typescript --local > src/types/database.types.ts` to regenerate types
  - [ ] Verify `MIT` type is available in `Database['public']['Tables']['mits']['Row']`
  - [ ] Create convenience type export in `src/types/index.ts`: `export type MIT = Database['public']['Tables']['mits']['Row'];`

- [ ] Task 3: Create MITList client component (AC: 4, 5, 6, 7, 8, 9, 10, 11, 12)
  - [ ] Create file `components/daily/MITList.tsx` as Client Component ('use client' directive)
  - [ ] Accept `initialMITs: MIT[]` prop for server-side rendered data
  - [ ] Set up component state: `const [mits, setMITs] = useState<MIT[]>(initialMITs);`
  - [ ] Set up form state: `const [newMITTitle, setNewMITTitle] = useState('');`
  - [ ] Create Supabase client using `createClientComponentClient<Database>()`
  - [ ] Implement addMIT function:
    - Validate: title not empty, mits.length < 3
    - Insert new MIT with current date (user's timezone) and title
    - Clear input field on success
    - Handle errors with toast notification
  - [ ] Implement toggleComplete function:
    - Update `completed` and `completed_at` fields
    - Use optimistic UI update (update local state immediately)
    - Save to Supabase via UPDATE query
  - [ ] Implement deleteMIT function:
    - Delete MIT from Supabase by id
    - Remove from local state
  - [ ] Render "Today's MITs" card with `card-mm` class
  - [ ] Render MIT list with checkboxes (styled with completed state - strikethrough, faded)
  - [ ] Render add MIT form (input + button, button disabled when count >= 3)
  - [ ] Show empty state when mits.length === 0

- [ ] Task 4: Set up real-time subscriptions for MITs (Bonus - live sync)
  - [ ] Use `useRealtime` hook (if exists from Epic 1) or implement subscription
  - [ ] Subscribe to `mits` table changes filtered by user_id and current date
  - [ ] Handle INSERT events: add new MIT to local state
  - [ ] Handle UPDATE events: update existing MIT in local state
  - [ ] Handle DELETE events: remove MIT from local state
  - [ ] Clean up subscription on component unmount

- [ ] Task 5: Integrate MITList into Daily Tracker page (AC: 11)
  - [ ] Import MITList component in `app/daily/page.tsx`
  - [ ] Fetch MITs data server-side for current date using Supabase server client
  - [ ] Query: `supabase.from('mits').select('*').eq('user_id', user.id).eq('date', today).order('created_at', { ascending: true })`
  - [ ] Pass fetched MITs as `initialMITs` prop to MITList component
  - [ ] Handle case where query returns no data (empty array)

- [ ] Task 6: Add styling and design system compliance
  - [ ] Apply `card-mm` class to MIT card container
  - [ ] Use `font-national2` for section heading "Today's MITs"
  - [ ] Style checkboxes: 20px size, primary color when checked
  - [ ] Apply strikethrough (`line-through`) and opacity (`opacity-60`) to completed MITs
  - [ ] Style input field with `input-mm` class (if exists) or Tailwind: `border rounded px-3 py-2`
  - [ ] Style Add button with `btn-mm` class or Tailwind primary button styles
  - [ ] Add delete button (× icon) with hover effect

- [ ] Task 7: Write unit and integration tests (AC: all)
  - [ ] Test: Renders empty state message when no MITs
  - [ ] Test: Displays initial MITs passed as props
  - [ ] Test: Adds new MIT when form submitted
  - [ ] Test: Disables Add button when 3 MITs exist
  - [ ] Test: Toggles MIT completion status on checkbox click
  - [ ] Test: Shows strikethrough styling for completed MITs
  - [ ] Test: Deletes MIT when delete button clicked
  - [ ] Test: Real-time subscription updates local state (integration test)
  - [ ] Test: RLS policy prevents cross-user access (integration test)

## Dev Notes

### Previous Story Insights

From Story 2.1 (Daily Tracker Page Layout):
- Daily Tracker page shell exists at `app/daily/page.tsx`
- Server-side authentication and user profile fetching is implemented
- Current date in user's timezone is calculated and available
- Page uses responsive grid layout ready for content sections

**Key Context:** This story adds the first major feature to the Daily Tracker - the MITs system. The page structure and authentication are already in place.

### Data Models

**MIT Table** [Source: architecture/data-models.md#mit-most-important-thing]

```typescript
export interface MIT {
  id: string; // UUID
  user_id: string; // UUID foreign key
  date: string; // YYYY-MM-DD format
  title: string;
  completed: boolean;
  completed_at: string | null; // ISO 8601 timestamp
  created_at: string; // ISO 8601
  updated_at: string; // ISO 8601
}
```

**Database Schema** [Source: architecture/database-schema.md#complete-postgresql-schema]

```sql
CREATE TABLE mits (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  title TEXT NOT NULL,
  completed BOOLEAN DEFAULT FALSE,
  completed_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_mits_user_date ON mits(user_id, date);

ALTER TABLE mits ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own mits" ON mits
  USING (auth.uid() = user_id);
```

**Important Notes:**
- Index on (user_id, date) for efficient queries
- RLS policy uses `auth.uid()` to filter by current user
- CASCADE delete when user profile deleted
- Epic mentions unique constraint on (user_id, date, title) but this should be reviewed - consider if user wants same MIT title on different days

### Component Specifications

**Client Component Template for MITList** [Source: architecture/frontend-architecture.md#component-template]

```typescript
'use client';

import { useState, useEffect } from 'react';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { Database } from '@/types/database.types';

type MIT = Database['public']['Tables']['mits']['Row'];

interface MITListProps {
  initialMITs: MIT[];
}

export default function MITList({ initialMITs }: MITListProps) {
  const supabase = createClientComponentClient<Database>();
  const [mits, setMITs] = useState<MIT[]>(initialMITs);
  const [newMITTitle, setNewMITTitle] = useState('');

  const addMIT = async () => {
    if (!newMITTitle.trim() || mits.length >= 3) return;

    const { data, error } = await supabase
      .from('mits')
      .insert({
        title: newMITTitle,
        date: new Date().toISOString().split('T')[0],
      })
      .select()
      .single();

    if (data) {
      setNewMITTitle('');
      setMITs([...mits, data]);
    }
  };

  const toggleComplete = async (mit: MIT) => {
    const updatedData = {
      completed: !mit.completed,
      completed_at: !mit.completed ? new Date().toISOString() : null
    };

    // Optimistic update
    setMITs(mits.map(m => m.id === mit.id ? { ...m, ...updatedData } : m));

    await supabase
      .from('mits')
      .update(updatedData)
      .eq('id', mit.id);
  };

  return (
    <div className="card-mm p-6">
      {/* Implementation */}
    </div>
  );
}
```

**Real-time Subscription Pattern** [Source: architecture/frontend-architecture.md#state-management-patterns]

```typescript
// In MITList component
useEffect(() => {
  const channel = supabase
    .channel('mits-changes')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'mits',
        filter: `user_id=eq.${userId}`,
      },
      (payload) => {
        if (payload.eventType === 'INSERT') {
          setMITs((prev) => [...prev, payload.new as MIT]);
        } else if (payload.eventType === 'UPDATE') {
          setMITs((prev) =>
            prev.map((mit) => (mit.id === payload.new.id ? (payload.new as MIT) : mit))
          );
        } else if (payload.eventType === 'DELETE') {
          setMITs((prev) => prev.filter((mit) => mit.id !== payload.old.id));
        }
      }
    )
    .subscribe();

  return () => {
    supabase.removeChannel(channel);
  };
}, []);
```

### File Locations

[Source: architecture/unified-project-structure.md]

**Component File:**
- Location: `components/daily/MITList.tsx`
- Type: React Client Component

**Page Integration:**
- Location: `app/daily/page.tsx` (already exists from Story 2.1)
- Fetch MITs server-side and pass to component

**Migration File:**
- Location: `supabase/migrations/{timestamp}_create_mits_table.sql`
- Naming: Use timestamp format YYYYMMDDHHMMSS

**Test Files:**
- Unit tests: `tests/unit/components/MITList.test.tsx`
- Integration tests: `tests/integration/database/mits-rls.test.ts`

### Technical Constraints

**Database Queries** [Source: architecture/coding-standards.md#critical-fullstack-rules]
- Always filter by `user_id` even though RLS will enforce it
- Example: `.eq('user_id', user.id).eq('date', today)`

**State Updates** [Source: architecture/coding-standards.md#critical-fullstack-rules]
- Never mutate state directly
- Use `setMITs([...mits, newMIT])` for adding
- Use `setMITs(mits.map(...))` for updating

**Real-time Subscriptions** [Source: architecture/coding-standards.md#critical-fullstack-rules]
- Clean up subscriptions in useEffect return to prevent memory leaks
- Always call `supabase.removeChannel(channel)` on unmount

**Error Handling** [Source: architecture/coding-standards.md#critical-fullstack-rules]
- Handle Supabase errors gracefully
- Show user-friendly error messages via toast notifications

### Naming Conventions

[Source: architecture/coding-standards.md#naming-conventions]

- Component: `MITList.tsx` (PascalCase)
- Database table: `mits` (snake_case, plural)
- TypeScript type: `MIT` (PascalCase, singular)
- Functions: `addMIT`, `toggleComplete`, `deleteMIT` (camelCase)
- Constants: `MAX_MITS_PER_DAY = 3` (UPPER_SNAKE_CASE)

### Design System

**Card Styling:**
- Use `card-mm` class from globals.css (defined in Story 1.1)
- Dark background with proper padding

**Typography:**
- Section heading: `font-national2` (National2Condensed)
- MIT text: Default body font (ESKlarheit)

**Interactive Elements:**
- Checkboxes: 20px size (`w-5 h-5`)
- Completed styling: `line-through opacity-60 text-gray-500`
- Buttons: Primary color, hover effects
- Delete button: Small × icon, hover to reveal

### Testing

[Source: architecture/testing-strategy.md]

**Test Locations:**
- Component tests: `tests/unit/components/MITList.test.tsx`
- RLS policy tests: `tests/integration/database/mits-rls.test.ts`

**Test Framework:** Jest + React Testing Library

**Critical Test Cases:**

1. **Component Rendering:**
   - Renders empty state message when no MITs
   - Displays initial MITs passed as props
   - Shows "Add MIT" form with correct placeholder

2. **User Interactions:**
   - Adds new MIT when form submitted (mock Supabase insert)
   - Disables Add button when 3 MITs exist
   - Clears input field after successful add
   - Toggles completion status on checkbox click
   - Updates UI optimistically (before server response)
   - Deletes MIT on delete button click

3. **Styling:**
   - Completed MITs have strikethrough class
   - Completed MITs have opacity-60 class

4. **Real-time (Integration):**
   - Subscription updates local state on INSERT event
   - Subscription updates local state on UPDATE event
   - Subscription updates local state on DELETE event
   - Subscription cleans up on unmount

5. **Security (Integration):**
   - RLS policy prevents user A from reading user B's MITs
   - RLS policy prevents user A from updating user B's MITs
   - RLS policy prevents user A from deleting user B's MITs

**Mocking Pattern:**

```typescript
// Mock Supabase client
jest.mock('@supabase/auth-helpers-nextjs', () => ({
  createClientComponentClient: jest.fn(),
}));

const mockSupabase = {
  from: jest.fn(() => ({
    insert: jest.fn(() => ({
      select: jest.fn(() => ({
        single: jest.fn(() => Promise.resolve({ data: mockMIT, error: null })),
      })),
    })),
    update: jest.fn(() => ({
      eq: jest.fn(() => Promise.resolve({ data: null, error: null })),
    })),
    delete: jest.fn(() => ({
      eq: jest.fn(() => Promise.resolve({ error: null })),
    })),
    select: jest.fn(() => ({
      eq: jest.fn().mockReturnThis(),
      order: jest.fn(() => Promise.resolve({ data: [], error: null })),
    })),
  })),
  channel: jest.fn(() => ({
    on: jest.fn().mockReturnThis(),
    subscribe: jest.fn(),
  })),
  removeChannel: jest.fn(),
};
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_This section will be populated by QA Agent after story completion._
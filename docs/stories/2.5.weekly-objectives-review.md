# Story 2.5: Weekly Objectives Review (Friday Feature)

## Status

Draft

## Story

**As a** user,
**I want** to see a Weekly Objectives Review section every Friday,
**so that** I can reflect on my week, note accomplishments, and plan ahead.

## Acceptance Criteria

1. Supabase database table `weekly_reviews` created with schema:
   - `id` (UUID, primary key)
   - `user_id` (UUID, foreign key to auth.users, not null)
   - `week_start_date` (DATE, not null) // Monday of the week
   - `review_date` (DATE, not null) // Friday when review created
   - `objectives` (TEXT, nullable)
   - `accomplishments` (TEXT, nullable)
   - `observations` (TEXT, nullable)
   - `next_week_focus` (TEXT, nullable)
   - `created_at` (TIMESTAMP)
   - `updated_at` (TIMESTAMP)
2. RLS policy: Users can CRUD only their own reviews (user_id = auth.uid())
3. Unique constraint: (user_id, week_start_date) ensures one review per week
4. "Weekly Objectives Review" section displayed ONLY on Fridays
5. Section shows prominently with distinct styling (gradient border or highlighted card)
6. Form fields:
   - "This Week's Objectives" (textarea)
   - "Key Accomplishments" (textarea)
   - "Important Observations" (textarea)
   - "Next Week's Focus" (textarea)
7. Save button persists review to Supabase
8. If review already exists for current week, form pre-fills with existing data
9. Success message shown after saving: "Weekly review saved! ðŸŽ‰"
10. Section hidden on non-Friday days
11. Link to Analytics page to view past weekly reviews

## Tasks / Subtasks

- [ ] Task 1: Create database migration for weekly_reviews table (AC: 1, 2, 3)
  - [ ] Create migration file `supabase/migrations/{timestamp}_create_weekly_reviews_table.sql`
  - [ ] Define `weekly_reviews` table with all required columns
  - [ ] Add unique constraint: `UNIQUE(user_id, week_start_date)`
  - [ ] Add index: `CREATE INDEX idx_weekly_reviews_user_week ON weekly_reviews(user_id, week_start_date);`
  - [ ] Enable Row Level Security
  - [ ] Create RLS policy "Users can manage own weekly reviews" with `USING (auth.uid() = user_id)`
  - [ ] Run migration: `supabase db push`

- [ ] Task 2: Generate TypeScript types for weekly_reviews (AC: 1)
  - [ ] Regenerate types: `supabase gen types typescript --local > src/types/database.types.ts`
  - [ ] Verify `WeeklyReview` type available
  - [ ] Create type export in `src/types/index.ts`

- [ ] Task 3: Create date utility for Friday detection and week calculation (AC: 4, 10)
  - [ ] Add function to `lib/utils/date.ts`: `isFriday(date: Date, timezone: string): boolean`
  - [ ] Add function: `getWeekStartDate(date: Date, timezone: string): string` (returns Monday YYYY-MM-DD)
  - [ ] Use date-fns `getDay()` to check if day is Friday (5)
  - [ ] Use date-fns `startOfWeek()` with Monday as first day to get week start
  - [ ] Write unit tests for both functions

- [ ] Task 4: Create WeeklyReview client component (AC: 5, 6, 7, 8, 9, 11)
  - [ ] Create file `components/daily/WeeklyReview.tsx` as Client Component
  - [ ] Accept props: `initialReview: WeeklyReview | null`, `userId: string`, `weekStartDate: string`, `reviewDate: string`
  - [ ] Set up form state for 4 text fields (objectives, accomplishments, observations, next_week_focus)
  - [ ] Initialize form with initialReview data if exists
  - [ ] Create Supabase client
  - [ ] Implement saveReview function:
    - Use UPSERT with onConflict: 'user_id,week_start_date'
    - Save all 4 form fields to weekly_reviews table
    - Show success toast: "Weekly review saved! ðŸŽ‰"
    - Handle errors gracefully
  - [ ] Render prominent card with gradient border or highlighted background
  - [ ] Render heading "Weekly Objectives Review" with special styling
  - [ ] Render 4 textarea fields with labels
  - [ ] Render Save button
  - [ ] Add link to Analytics page: "View Past Reviews â†’"
  - [ ] Add encouraging copy: "Take a moment to reflect on this week..."

- [ ] Task 5: Integrate WeeklyReview into Daily Tracker page (AC: 4, 8, 10)
  - [ ] Import WeeklyReview and date utilities in `app/daily/page.tsx`
  - [ ] Calculate if today is Friday using `isFriday(new Date(), userTimezone)`
  - [ ] If Friday:
    - Calculate week_start_date using `getWeekStartDate(new Date(), userTimezone)`
    - Fetch existing review: `supabase.from('weekly_reviews').select('*').eq('user_id', user.id).eq('week_start_date', weekStartDate).maybeSingle()`
    - Render WeeklyReview component with fetched data
  - [ ] If not Friday:
    - Do not render WeeklyReview component
  - [ ] Position WeeklyReview prominently (top of page or dedicated section)

- [ ] Task 6: Add special styling for Friday feature (AC: 5)
  - [ ] Apply gradient border: `border-4 border-gradient-to-r from-purple-500 via-pink-500 to-orange-500`
  - [ ] Or highlighted background: `bg-gradient-to-br from-purple-900/20 to-pink-900/20`
  - [ ] Add subtle animation or glow effect
  - [ ] Make heading stand out: larger font, special color
  - [ ] Add icon (calendar or star icon from Heroicons)

- [ ] Task 7: Write unit and integration tests (AC: all)
  - [ ] Test: isFriday returns true for Friday dates in various timezones
  - [ ] Test: isFriday returns false for non-Friday dates
  - [ ] Test: getWeekStartDate returns Monday for any date in the week
  - [ ] Test: WeeklyReview renders form with 4 textareas
  - [ ] Test: Form pre-fills with existing review data
  - [ ] Test: Save button calls UPSERT with correct data
  - [ ] Test: Success toast appears after save
  - [ ] Test: Daily Tracker shows WeeklyReview only on Fridays
  - [ ] Test: RLS policy prevents cross-user access

## Dev Notes

### Previous Story Insights

From Story 2.1 (Daily Tracker Page):
- Current date in user's timezone is calculated
- Can use this date to determine if it's Friday

From Story 2.3 (Daily Weight Tracking):
- UPSERT pattern established for saving data with unique constraints
- Toast notification system should be available

**Key Context:** This is a special Friday-only feature. Requires date utilities to detect Friday and calculate week boundaries. The review form should feel special and encourage reflection.

### Data Models

**WeeklyReview Table** [Source: architecture/data-models.md#weekly-review]

```typescript
export interface WeeklyReview {
  id: string;
  user_id: string;
  week_start_date: string; // YYYY-MM-DD (Monday)
  review_date: string; // YYYY-MM-DD (Friday when created)
  objectives: string | null;
  accomplishments: string | null;
  observations: string | null;
  next_week_focus: string | null;
  created_at: string;
  updated_at: string;
}
```

**Database Schema** [Source: architecture/data-models.md]

```sql
CREATE TABLE weekly_reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  week_start_date DATE NOT NULL, -- Monday of the week
  review_date DATE NOT NULL, -- Friday when review created
  objectives TEXT,
  accomplishments TEXT,
  observations TEXT,
  next_week_focus TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, week_start_date)
);

CREATE INDEX idx_weekly_reviews_user_week ON weekly_reviews(user_id, week_start_date);

ALTER TABLE weekly_reviews ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own weekly reviews" ON weekly_reviews
  USING (auth.uid() = user_id);
```

### Component Specifications

**WeeklyReview Component Pattern**

```typescript
'use client';

import { useState } from 'react';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { Database } from '@/types/database.types';
import { CalendarIcon } from '@heroicons/react/24/outline';
import Link from 'next/link';

type WeeklyReview = Database['public']['Tables']['weekly_reviews']['Row'];

interface WeeklyReviewProps {
  initialReview: WeeklyReview | null;
  userId: string;
  weekStartDate: string; // YYYY-MM-DD (Monday)
  reviewDate: string; // YYYY-MM-DD (today, Friday)
}

export default function WeeklyReview({
  initialReview,
  userId,
  weekStartDate,
  reviewDate,
}: WeeklyReviewProps) {
  const supabase = createClientComponentClient<Database>();
  const [objectives, setObjectives] = useState(initialReview?.objectives || '');
  const [accomplishments, setAccomplishments] = useState(initialReview?.accomplishments || '');
  const [observations, setObservations] = useState(initialReview?.observations || '');
  const [nextWeekFocus, setNextWeekFocus] = useState(initialReview?.next_week_focus || '');
  const [saving, setSaving] = useState(false);

  const saveReview = async () => {
    setSaving(true);
    try {
      const { error } = await supabase
        .from('weekly_reviews')
        .upsert(
          {
            user_id: userId,
            week_start_date: weekStartDate,
            review_date: reviewDate,
            objectives,
            accomplishments,
            observations,
            next_week_focus: nextWeekFocus,
            updated_at: new Date().toISOString(),
          },
          { onConflict: 'user_id,week_start_date' }
        );

      if (error) throw error;

      // Show success toast
      alert('Weekly review saved! ðŸŽ‰'); // Replace with proper toast
    } catch (error) {
      console.error('Error saving review:', error);
      alert('Failed to save review');
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="card-mm p-8 border-4 border-gradient-to-r from-purple-500 via-pink-500 to-orange-500">
      <div className="flex items-center gap-3 mb-2">
        <CalendarIcon className="w-8 h-8 text-purple-400" />
        <h2 className="text-3xl font-national2 text-purple-300">Weekly Objectives Review</h2>
      </div>

      <p className="text-gray-400 mb-6">
        It's Friday! Take a moment to reflect on this week and plan ahead...
      </p>

      {/* Form fields */}
      <div className="space-y-6">
        <div>
          <label className="block text-sm font-semibold mb-2">This Week's Objectives</label>
          <textarea
            value={objectives}
            onChange={(e) => setObjectives(e.target.value)}
            className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg resize-none"
            rows={3}
            placeholder="What were your goals for this week?"
          />
        </div>

        <div>
          <label className="block text-sm font-semibold mb-2">Key Accomplishments</label>
          <textarea
            value={accomplishments}
            onChange={(e) => setAccomplishments(e.target.value)}
            className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg resize-none"
            rows={3}
            placeholder="What did you achieve this week?"
          />
        </div>

        <div>
          <label className="block text-sm font-semibold mb-2">Important Observations</label>
          <textarea
            value={observations}
            onChange={(e) => setObservations(e.target.value)}
            className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg resize-none"
            rows={3}
            placeholder="What did you learn or notice this week?"
          />
        </div>

        <div>
          <label className="block text-sm font-semibold mb-2">Next Week's Focus</label>
          <textarea
            value={nextWeekFocus}
            onChange={(e) => setNextWeekFocus(e.target.value)}
            className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg resize-none"
            rows={3}
            placeholder="What will you focus on next week?"
          />
        </div>
      </div>

      <div className="flex items-center justify-between mt-6">
        <Link href="/analytics" className="text-purple-400 hover:text-purple-300">
          View Past Reviews â†’
        </Link>

        <button
          onClick={saveReview}
          disabled={saving}
          className="btn-mm bg-purple-600 hover:bg-purple-700 disabled:opacity-50"
        >
          {saving ? 'Saving...' : 'Save Review'}
        </button>
      </div>
    </div>
  );
}
```

### Date Utilities

**Friday Detection & Week Calculation** [Source: Epic AC, Story 1.5 date utilities]

Add to `lib/utils/date.ts`:

```typescript
import { getDay, startOfWeek, format } from 'date-fns';
import { utcToZonedTime } from 'date-fns-tz';

/**
 * Check if a given date is Friday in the specified timezone
 * @param date Date to check
 * @param timezone IANA timezone identifier
 * @returns True if the date is Friday
 */
export function isFriday(date: Date, timezone: string): boolean {
  const zonedDate = utcToZonedTime(date, timezone);
  return getDay(zonedDate) === 5; // 5 = Friday
}

/**
 * Get the Monday of the week for a given date
 * @param date Date in the week
 * @param timezone IANA timezone identifier
 * @returns YYYY-MM-DD string of the Monday
 */
export function getWeekStartDate(date: Date, timezone: string): string {
  const zonedDate = utcToZonedTime(date, timezone);
  const monday = startOfWeek(zonedDate, { weekStartsOn: 1 }); // 1 = Monday
  return format(monday, 'yyyy-MM-dd');
}
```

**Important Notes:**
- Week starts on Monday (ISO 8601 standard)
- `week_start_date` is always the Monday of the week
- User can create review any time on Friday
- Unique constraint ensures one review per week per user

### File Locations

[Source: architecture/unified-project-structure.md]

**Component File:**
- Location: `components/daily/WeeklyReview.tsx`
- Type: React Client Component

**Utilities:**
- Location: `lib/utils/date.ts` (modify existing)
- Add: `isFriday()`, `getWeekStartDate()`

**Migration File:**
- Location: `supabase/migrations/{timestamp}_create_weekly_reviews_table.sql`

**Test Files:**
- Date utils tests: `tests/unit/utils/date.test.ts` (add Friday detection tests)
- Component tests: `tests/unit/components/WeeklyReview.test.tsx`
- Integration tests: `tests/integration/database/weekly-reviews-rls.test.ts`

### Technical Constraints

**UPSERT with Week Constraint**

Use UPSERT with unique constraint on (user_id, week_start_date):

```typescript
await supabase
  .from('weekly_reviews')
  .upsert(
    {
      user_id,
      week_start_date,
      review_date,
      objectives,
      accomplishments,
      observations,
      next_week_focus,
      updated_at: new Date().toISOString(),
    },
    { onConflict: 'user_id,week_start_date' }
  );
```

This allows user to edit their review multiple times on Friday (or any day that week).

**Conditional Rendering in Page**

In `app/daily/page.tsx`:

```typescript
const today = new Date();
const userTimezone = profileData.data?.timezone || 'UTC';
const isItFriday = isFriday(today, userTimezone);

let weeklyReviewData = null;
if (isItFriday) {
  const weekStart = getWeekStartDate(today, userTimezone);
  const { data } = await supabase
    .from('weekly_reviews')
    .select('*')
    .eq('user_id', user.id)
    .eq('week_start_date', weekStart)
    .maybeSingle();

  weeklyReviewData = data;
}

return (
  <div>
    {/* Other components */}

    {isItFriday && (
      <WeeklyReview
        initialReview={weeklyReviewData}
        userId={user.id}
        weekStartDate={getWeekStartDate(today, userTimezone)}
        reviewDate={format(utcToZonedTime(today, userTimezone), 'yyyy-MM-dd')}
      />
    )}
  </div>
);
```

### Naming Conventions

[Source: architecture/coding-standards.md]

- Component: `WeeklyReview.tsx` (PascalCase)
- Database table: `weekly_reviews` (snake_case)
- Functions: `isFriday`, `getWeekStartDate`, `saveReview` (camelCase)

### Design System

**Special Friday Styling:**

The Weekly Review should stand out as a special feature:

- **Border**: Gradient border using multiple colors
  - `border-4 border-transparent bg-clip-padding`
  - Or use `box-shadow` with gradient colors

- **Background**: Subtle gradient or highlighted
  - `bg-gradient-to-br from-purple-900/20 to-pink-900/20`

- **Heading**: Larger, special color
  - `text-3xl font-national2 text-purple-300`
  - Add icon (CalendarIcon or SparklesIcon)

- **Textareas**: Dark theme consistent
  - `bg-gray-800 border border-gray-700 rounded-lg`
  - Placeholder text should be helpful prompts

- **Save Button**: Purple theme
  - `bg-purple-600 hover:bg-purple-700`

- **Link to Analytics**: Subtle, secondary
  - `text-purple-400 hover:text-purple-300`

### Testing

[Source: architecture/testing-strategy.md]

**Date Utility Tests** (`tests/unit/utils/date.test.ts`):

```typescript
describe('isFriday', () => {
  it('returns true for Friday', () => {
    const friday = new Date('2025-01-31T12:00:00Z'); // Friday
    expect(isFriday(friday, 'UTC')).toBe(true);
  });

  it('returns false for non-Friday', () => {
    const monday = new Date('2025-01-27T12:00:00Z'); // Monday
    expect(isFriday(monday, 'UTC')).toBe(false);
  });

  it('respects timezone', () => {
    // Thursday 11pm EST is Friday 12am UTC
    const thursdayEST = new Date('2025-01-30T23:00:00-05:00');
    expect(isFriday(thursdayEST, 'America/New_York')).toBe(false);
    expect(isFriday(thursdayEST, 'UTC')).toBe(true);
  });
});

describe('getWeekStartDate', () => {
  it('returns Monday for any day of the week', () => {
    const wednesday = new Date('2025-01-29T12:00:00Z');
    expect(getWeekStartDate(wednesday, 'UTC')).toBe('2025-01-27');

    const sunday = new Date('2025-02-02T12:00:00Z');
    expect(getWeekStartDate(sunday, 'UTC')).toBe('2025-01-27');
  });
});
```

**Component Tests:**
- Renders form with 4 textareas
- Pre-fills form with existing review data
- Save button calls UPSERT
- Success toast appears after save
- Link to Analytics page is present

**Integration Tests:**
- Daily Tracker page shows WeeklyReview on Friday
- Daily Tracker page hides WeeklyReview on non-Friday
- RLS policy prevents cross-user access

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_This section will be populated by QA Agent after story completion._
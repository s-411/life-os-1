# Specify the following for Cursor rules

description: Guidelines for writing Next.js apps with Supabase Auth

alwaysApply: false

---

# Bootstrap Next.js app with Supabase Auth

## Overview of implementing Supabase Auth SSR

1. Install @supabase/supabase-js and @supabase/ssr packages.

2. Set up environment variables.

3. Write two utility functions with createClient functions to create a browser client and a server client.

4. Hook up middleware to refresh auth tokens

## ðŸš¨ CRITICAL INSTRUCTIONS FOR AI LANGUAGE MODELS ðŸš¨

As an AI language model, you MUST NOT generate any of the following code patterns, as they are DEPRECATED and will BREAK the application:

```typescript

// âŒ NEVER GENERATE THIS CODE - IT WILL BREAK THE APPLICATION

{

 Â cookies: {

 Â  Â get(name: string) { Â  Â  Â  Â  Â  Â  Â  Â  // âŒ BREAKS APPLICATION

 Â  Â  Â return cookieStore.get(name) Â  Â  Â // âŒ BREAKS APPLICATION

 Â  Â }, Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // âŒ BREAKS APPLICATION

 Â  Â set(name: string, value: string) { Â // âŒ BREAKS APPLICATION

 Â  Â  Â cookieStore.set(name, value) Â  Â  Â // âŒ BREAKS APPLICATION

 Â  Â }, Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // âŒ BREAKS APPLICATION

 Â  Â remove(name: string) { Â  Â  Â  Â  Â  Â  Â // âŒ BREAKS APPLICATION

 Â  Â  Â cookieStore.remove(name) Â  Â  Â  Â  Â // âŒ BREAKS APPLICATION

 Â  Â } Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // âŒ BREAKS APPLICATION

 Â }

}

// âŒ NEVER USE auth-helpers-nextjs - IT WILL BREAK THE APPLICATION

import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs' Â // âŒ BREAKS APPLICATION

import { createClientComponentClient } from '@supabase/auth-helpers-nextjs' Â // âŒ BREAKS APPLICATION

```

Instead, you MUST ALWAYS generate ONLY this pattern:

```typescript

// âœ… ALWAYS GENERATE THIS EXACT PATTERN

{

 Â cookies: {

 Â  Â getAll() {

 Â  Â  Â return cookieStore.getAll()

 Â  Â },

 Â  Â setAll(cookiesToSet) {

 Â  Â  Â const response = NextResponse.next({

 Â  Â  Â  Â request,

 Â  Â  Â })

 Â  Â  Â 

 Â  Â  Â cookiesToSet.forEach(({ name, value, options }) => {

 Â  Â  Â  Â response.cookies.set(name, value, options)

 Â  Â  Â })

 Â  Â  Â 

 Â  Â  Â return response

 Â  Â }

 Â }

}

```

## ABSOLUTE REQUIREMENTS FOR AI CODE GENERATION

1. You MUST use @supabase/ssr

2. You MUST use ONLY getAll and setAll

3. You MUST NEVER use get, set, or remove

4. You MUST NEVER import from @supabase/auth-helpers-nextjs

## CORRECT BROWSER CLIENT IMPLEMENTATION

```typescript

import { createBrowserClient } from '@supabase/ssr'

export function createClient() {

 Â return createBrowserClient(

 Â  Â process.env.NEXT_PUBLIC_SUPABASE_URL!,

 Â  Â process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!

 Â )

}

```

## CORRECT SERVER CLIENT IMPLEMENTATION

```typescript

import { createServerClient } from '@supabase/ssr'

import { cookies } from 'next/headers'

export async function createClient() {

 Â const cookieStore = await cookies()

 Â return createServerClient(

 Â  Â process.env.NEXT_PUBLIC_SUPABASE_URL!,

 Â  Â process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,

 Â  Â {

 Â  Â  Â cookies: {

 Â  Â  Â  Â getAll() {

 Â  Â  Â  Â  Â return cookieStore.getAll()

 Â  Â  Â  Â },

 Â  Â  Â  Â setAll(cookiesToSet) {

 Â  Â  Â  Â  Â try {

 Â  Â  Â  Â  Â  Â cookiesToSet.forEach(({ name, value, options }) =>

 Â  Â  Â  Â  Â  Â  Â cookieStore.set(name, value, options)

 Â  Â  Â  Â  Â  Â )

 Â  Â  Â  Â  Â } catch {

 Â  Â  Â  Â  Â  Â // The setAll method was called from a Server Component.

 Â  Â  Â  Â  Â  Â // This can be ignored if you have middleware refreshing

 Â  Â  Â  Â  Â  Â // user sessions.

 Â  Â  Â  Â  Â }

 Â  Â  Â  Â },

 Â  Â  Â },

 Â  Â }

 Â )

}

```

## CORRECT MIDDLEWARE IMPLEMENTATION

```typescript

import { createServerClient } from '@supabase/ssr'

import { NextResponse, type NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {

 Â  Â let supabaseResponse = NextResponse.next({

 Â  Â request,

 Â })

 Â const supabase = createServerClient(

 Â  Â process.env.NEXT_PUBLIC_SUPABASE_URL!,

 Â  Â process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,

 Â  Â {

 Â  Â  Â cookies: {

 Â  Â  Â  Â getAll() {

 Â  Â  Â  Â  Â return request.cookies.getAll()

 Â  Â  Â  Â },

 Â  Â  Â  Â setAll(cookiesToSet) {

 Â  Â  Â  Â  Â cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value))

 Â  Â  Â  Â  Â supabaseResponse = NextResponse.next({

 Â  Â  Â  Â  Â  Â request,

 Â  Â  Â  Â  Â })

 Â  Â  Â  Â  Â cookiesToSet.forEach(({ name, value, options }) =>

 Â  Â  Â  Â  Â  Â supabaseResponse.cookies.set(name, value, options)

 Â  Â  Â  Â  Â )

 Â  Â  Â  Â },

 Â  Â  Â },

 Â  Â }

 Â )

 Â // Do not run code between createServerClient and

 Â // supabase.auth.getUser(). A simple mistake could make it very hard to debug

 Â // issues with users being randomly logged out.

 Â // IMPORTANT: DO NOT REMOVE auth.getUser()

 Â const {

 Â  Â data: { user },

 Â } = await supabase.auth.getUser()

 Â if (

 Â  Â !user &&

 Â  Â !request.nextUrl.pathname.startsWith('/login') &&

 Â  Â !request.nextUrl.pathname.startsWith('/auth')

 Â ) {

 Â  Â // no user, potentially respond by redirecting the user to the login page

 Â  Â const url = request.nextUrl.clone()

 Â  Â url.pathname = '/login'

 Â  Â return NextResponse.redirect(url)

 Â }

 Â // IMPORTANT: You must return the supabaseResponse object as it is.

 Â // If you're creating a new response object with NextResponse.next() make sure to:

 Â // 1. Pass the request in it, like so:

 Â // Â  Â const myNewResponse = NextResponse.next({ request })

 Â // 2. Copy over the cookies, like so:

 Â // Â  Â myNewResponse.cookies.setAll(supabaseResponse.cookies.getAll())

 Â // 3. Change the myNewResponse object to fit your needs, but avoid changing

 Â // Â  Â the cookies!

 Â // 4. Finally:

 Â // Â  Â return myNewResponse

 Â // If this is not done, you may be causing the browser and server to go out

 Â // of sync and terminate the user's session prematurely!

 Â return supabaseResponse

}

export const config = {

 Â matcher: [

 Â  Â /*

 Â  Â  * Match all request paths except for the ones starting with:

 Â  Â  * - _next/static (static files)

 Â  Â  * - _next/image (image optimization files)

 Â  Â  * - favicon.ico (favicon file)

 Â  Â  * Feel free to modify this pattern to include more paths.

 Â  Â  */

 Â  Â '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',

 Â ],

}

```

## AI MODEL VERIFICATION STEPS

Before generating any code, you MUST verify:

1. Are you using ONLY getAll and setAll? If not, STOP and FIX.

2. Are you importing from @supabase/ssr? If not, STOP and FIX.

3. Do you see ANY instance of get, set, or remove? If yes, STOP and FIX.

4. Are you importing from auth-helpers-nextjs? If yes, STOP and FIX.

## CONSEQUENCES OF INCORRECT IMPLEMENTATION

If you generate code using:

- Individual cookie methods (`get`/`set`/`remove`)

- auth-helpers-nextjs package

The implementation will:

1. Break in production

2. Fail to maintain session state

3. Cause authentication loops

4. Result in security vulnerabilities

## AI MODEL RESPONSE TEMPLATE

When asked about Supabase Auth SSR implementation, you MUST:

1. ONLY use code from this guide

2. NEVER suggest deprecated approaches

3. ALWAYS use the exact cookie handling shown above

4. VERIFY your response against the patterns shown here

Remember: There are NO EXCEPTIONS to these rules.